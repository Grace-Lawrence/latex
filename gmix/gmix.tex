\documentclass[12pt,preprint]{aastex}

\usepackage{verbatim}
\usepackage{color}

\usepackage[normalem]{ulem} % for striking out with \sout
\input{newcommands.tex}

\newcommand{\M}{\textbf{M}}
\newcommand{\X}{\textbf{X}}
\newcommand{\Dx}{\ensuremath{\Delta x}}
\newcommand{\Dy}{\ensuremath{\Delta y}}
\newcommand{\aratio}{\ensuremath{\sigma^2_{psf}/\sigma^2_{gal}}}
%\newcommand{\aratio}{$\sigma^2_{psf}/\sigma^2_{gal}$}

\newcommand{\downloadURL}{{\tt http://www.sdss3.org/dr8/data\_access.php\#VAC}}
\newcommand{\datamodelURL}{{\tt http://data.sdss3.org/datamodel/files/BOSS\_PHOTOOBJ/photoz-weight/pofz.html}}
\def\eps@scaling{1.0}% 

\slugcomment{Last revision \today}
\shortauthors{Sheldon}
\shorttitle{Gaussian Mixtures for Shape Measurement}

\begin{document}

\title{Gaussian Mixtures for Shape Measurement}

\input{authors.tex}

\begin{abstract}

GMix

\end{abstract}

\section{Gaussian Mixtures} \label{sec:gmix}

The two dimensional Gaussian intensity function is defined as
\begin{equation}
G = \frac{p}{2 \pi \sqrt{|\M|} } ~~ \textrm{exp}\left( -\frac{1}{2} \X^T \M^{-1} \X \right)
\end{equation}
where \M\ is the covariance matrix
\begin{equation}
\M = \left( \begin{array}{cc}
\M_{xx} & \M_{xy} \\
\M_{xx} & \M_{yy} \end{array} \right)
\end{equation}
and \X\ is the position vector relative to the mean of the Gaussian
\begin{equation}
\X = \left( \begin{array}{c}
\Dx \\
\Dy \end{array} \right),
\end{equation}
where we have defined the positions relative to the center $(x_0,y_0)$
as $\Delta x=(x-x_0)$ and $\Delta y=(y-y_0)$.

Under convolution with a Gaussian point-spread-function (PSF) $P$ we get an
observed model intensity profile
\begin{equation}
G_o = G * P
\end{equation}
In this case the covariance matrices simply add
\begin{equation}
\M_o = \M + \M_{P}
\end{equation}

We can fit a number of gaussians to a galaxy or star image.  There is 
no guarantee this will be a good representation, as sums of Gaussians
do not form a complete set of functions.   This model can be represented
as
\begin{equation}
I = \sum_{i=1}^{N_{g}} p_i G_i
\end{equation}

If the PSF is also represented as a sum of gaussians, then the observed
light intensity profile can be modeled as
\begin{eqnarray} \label{eq:postpsf}
I_o & = & \sum_{i=1}^{N_{g}} p_i \sum_{j=1}^{N_{P}} G_i * P_j \\
    & = & \sum_{i=1}^{N_{g}} p_i \sum_{j=1}^{N_{P}} \frac{1}{2 \pi \sqrt{|\M + \M_P|} } ~~ \textrm{exp}\left( -\frac{1}{2} \X^T (\M+\M_P)^{-1} \X \right) \\
\end{eqnarray}
where the $P_j$ are normalized such that the integral over
the plane is unity
\begin{equation}
\int \sum_{j=1}^{N_{P}} P_j dA = 1.
\end{equation}

A Gaussian defined as above has 6 parameters, $x_0, y_0, \textrm{M}_{xx},
\textrm{M}_{xy}, \textrm{M}_{yy},$ and an intensity $p$.  We define a general gaussian
mixture as a set of $N_g$ Gaussians.  Such a Gaussian 
mixture has $6 N_g$ total parameters.

\subsection{Alternative Parametrization}

An alternative parametrization of the covariance matrix is in
terms of the ellipticity parameters and size
\begin{equation}
\M = \frac{T}{2}\left( \begin{array}{cc}
1+e_1 & e_2 \\
e_2 & 1-e_1 \end{array} \right),
\end{equation}
where the ellipticity and size $T$ are defined in terms
of the elements of the covariance matrix as
\begin{eqnarray}
T & = & M_{xx} + M_{yy} \\
e_1 & = & \frac{M_{xx}-M_{yy}}{T} \\
e_2 & = & \frac{2 M_{xy}}{T} \\
e & = & \sqrt{e_1^2 + e_2^2}.
\end{eqnarray}
The $e_1$ and $e_2$ are bounded within $[-1,1]$ and total ellipticity $e$ is
within $[0,1]$.  Note in this parametrization, 
the argument of the exponential is
\begin{equation}
\frac{1}{2} \X^T \M^{-1} \X = \frac{\Dx^2 (1-e_1) - 2 \Dx \Dy~e_2 + \Dy^2 (1+e_1)}{T (1-e^2)}
\end{equation}


\subsection{Co-elliptical Gaussians}

We will find it useful to use co-elliptical Gaussians; Gaussians with
proportional covariance matrices.  In this case, the dimensionality for $N_g$
Gaussians is reduced from $6 N_g$ to $2 N_g + 4$.  We parametrize this model
with $x_0, y_0, e_1, e_2, T_{max}, f_{i}, p_{i}$ where $T_{max}$ represents
the largest gaussian and $f_{i} = T_{i}/T_{max}$.


\section{Examples}

In this section we show some fits to example profiles.

\subsection{Exponential Disk}

An exponential disk can be represented reasonably well by three Gaussians
as shown in Fig. 
%\ref{fig:expcmp}

%\begin{figure}[t] \centering
% \centering 
% \includegraphics[scale=0.7]{figures/test-opt-exp.eps}

% \caption{A fit to an exponential disk using three Gaussians.}
% \label{fig:expcmp}

%\end{figure}



\section{Fitting for the Pre-PSF Object}

In order to fit for the pre-psf object, we first fit the PSF to a gaussian
mixture.  Then, for a given set of object parameters, we generate a model that
is convolved with this PSF according to equation \ref{eq:postpsf} and compare
with the image.  We then search for a set of parameters that give the best fit
in a $\chi^2$ sense.  

Note both the object and PSF are convolved with the pixel response function.
This pixelization is accounted for when fitting a Gaussian mixture model to the
observed PSF.  Thus when generating our model using equation \ref{eq:postpsf},
the we fit for parameters of an object before convolution with the PSF,
including the pixel response.


\section{Simulations} \label{sec:sim}

We generated a set of mock galaxy and PSF images for test purposes.  We use
three different elliptical galaxy models: Gaussian, exponential, de
Vaucouleurs' model \citep{devauc1948}.  We also use three different PSF models:
Gaussian, double Gaussian, and a PSF representing atmospheric turbulence.

For the special case of a Gaussian galaxy convolved by Gaussian PSF, the
convolution is performed analytically and only convolution with the pixel
response is done numerically.  

For non-Gaussian models we use a Fast Fourier Transform (FFT) convolution (XXX
cite FFT and scipy).  We first generate the images on a super-fine mesh. We
then FFT the image, multiply the image by the PSF in Fourier space, and
transform back. Finally, we re-sample at the desired pixel scale.  Using this
fine mesh is a fast way to perform accurate convolution with the pixel response
and is necessary for accurate FFTs.  We performed convergence tests for each
type of profile to determine the sampling required to obtain accurate results.

Gaussian and turbulent PSFs have closed mathematical forms in Fourier space.
When convolving a Gaussian with a non-Gaussian object, or when using a
turbulent PSF, we generate the PSF in Fourier space directly.
PSF (XXX cite kaiser, others) only has a closed form in Fourier space, and thus
also required in Fourier space.

\subsection{Simulation Parameters}

For all simulation runs we use a single PSF and galaxy type with different
orientations and noise properties.  The relevant parameters for each simulation
are the galaxy ellipticity $e$, the ratio of PSF area to galaxy area \aratio, the
signal to noise ratio S/N, and the applied shear $\gamma$.

The area ratio \aratio\ is defined as the ratio of the unweighted second
moments of PSF and object.  As such, it does not correspond directly to the
area ratio as determined by weighted moments or of any particular fitting
routine in the presense of noise.  For very extended objects such as \devauc\
profile, it may be impossible to recover the true size of the object at
low S/N.  We use \aratio\ simply as a label.

Similarly, the S/N is defined arbitrarily as the ``optimally matched''
detection S/N.  This is a sum of the image intensity $I_i$ over pixels $i$
\begin{equation}
\left(\frac{S}{N}\right)^2_{matched} = \frac{1}{n} \sum_{i} I_i^2.
\end{equation}
where we have assumed unit pixels and $n$ is a uniform variance per pixel.
This can be shown to be the maximal measure of detection S/N under the
assumptions of sky-noise limited images and uniform noise \citep{plazasthesis}.
It is important to think of this simply as a, fairly arbitrary, label.  The
unweighted S/N is typically much smaller, and the ratio between the optimal and
unweighted S/N depends dramatically on the galaxy profile and aperture.

\subsection{Applied Shear} \label{sec:sim:shear}

For each set of images, we add a constant, weak shear of order 0.01.  We do not
attempt to recover spatially varying shear.  We applied the shear using the
addition rule for distortions as given by Equation 2.6 of
\citet{Escude91}. A galaxy with intrinsice shape $(e_1,e_2)$, when
sheared with a distortion $(\delta_1, \delta_2)$ will have an observed
ellipticity
\begin{eqnarray}
e_1^o  & = & \frac
{e_1 + \delta_1 + \delta_2/\delta^2\left[1 - \sqrt{1-\delta^2}\right]\left( \delta_1 e_2 - \delta_2 e_1\right)}
{1 + \delta_1 e_1 + \delta_2 e_2 } \\
e_2^o  & = & \frac
{e_2 + \delta_2 + \delta_1/\delta^2\left[1 - \sqrt{1-\delta^2}\right]\left( \delta_2 e_1 - \delta_1 e_2\right)}
{1 + \delta_1 e_1 + \delta_2 e_2 },
\end{eqnarray}
where, again, superscript $o$ denotes ``observed'' quantities.

One can transform between shear and $\delta$ using the rules given by
\citet{bern02} in Section 2.2; note however, that we use the ellipticity 
$e$ interchangeably with distortion $\delta$, where as \citet{bern02} define
$e$ as $1-q$ where $q$ is the axis ratio.

\subsection{Models}

\section{Shape Recovery}

In this section we discuss the accurately of our galaxy shape recovery for
various models, as a function of ellipticity, resolution and S/N.

\section{Shear Recover Using Ring Tests}

In this section we demonstrate how accurately we recover shear as a function of
S/N and ellipticity.  Since S/N and resolution are more important determinants
than ellipticity, we only show results for a few values of ellipticity.

For each realization of galaxy ellipticity, we place pairs of images at exactly
90 degree separation in the full range of position angle $2 \theta \in
[0,360)$.  When using this so-called ``ring test'' \citep{Nakajima2007}, the
noise from the intrinsic galaxy shape cancels exactly in the absence of noise.
Since this ``shape noise'' will dominate the noise in many cases, the ring test
reduces the number of mocks needed to accurately test shear recovery for our
algorithm.


\bibliographystyle{apj}
% Bib database
\bibliography{apj-jour,astroref}

\appendix 

\section{Appendix}
\subsection{Jacobian}

The Jacobian is the set of first derivatives of model with respect
to the parameters:
\begin{equation}
J_i = \frac{\partial G}{\partial \beta_i}
\end{equation}
The jacobian can be useful in some fitting routines to help guide the descent
to best fit.

For a single Gaussian, the elements of the Jacobian can be readily
calculated.  For the parameters $x_0,y_0,\theta,T,p$ we find
\begin{eqnarray}
\frac{1}{G} \frac{\partial G}{\partial x_0}
    & = & 2 \frac{ \Dx (1-e_1) - \Dy e_2 }{T (1-e^2)} \\
\frac{1}{G} \frac{\partial G}{\partial y_0}
    & = & 2 \frac{ \Dy (1+e_1) - \Dx e_2 }{T (1-e^2)} \\
\frac{1}{G} \frac{\partial G}{\partial e_1}
  & = & \frac{e_1}{1-e^2} + \frac{\Dx^2-\Dy^2}{T (1-e^2)^2} (1-e^2 + 2 e_1^2) \\
\frac{1}{G} \frac{\partial G}{\partial e_2}
  & = & \frac{e_2}{1-e^2} + \frac{2 \Dx \Dy}{T (1-e^2)^2} (1-e^2 + 2 e_2^2) \\
\frac{1}{G} \frac{\partial G}{\partial T}
  & = & \frac{-1}{T} \left( 1 - \frac{1}{2} \X^T \M^{-1} \X  \right)  \\
\frac{1}{G} \frac{\partial G}{\partial p}
  & = & \frac{1}{p}
\end{eqnarray}

\subsection{Jacobian in the Presence of a PSF}

For $x_0,y_0,T$ and $p$, we can use the same Jacobian equations for the pre-PSF
case, evaluated with the convolved covariance matrix. 

For $e_1$ and $e_2$ we modify the jacobians according to the following equations
\begin{eqnarray}
\frac{\partial G_o}{\partial e_1} 
 & = & \frac{\partial G_o}{\partial e_1^o} \frac{\partial e_1^o}{\partial e_1} 
    =  R \frac{\partial G_o}{\partial e_1^o}\\
\frac{\partial G_o}{\partial e_2} 
 & = & \frac{\partial G_o}{\partial e_2^o} \frac{\partial e_2^o}{\partial e_2}
    =  R \frac{\partial G_o}{\partial e_2^o}\\
R & = & \frac{T}{T + T_P} = \frac{T}{T_o}.
\end{eqnarray}
where quantities sub- or super-scripted with $o$ are convolved or ``observed''
quantities, and we have defined the resolution parameter $R$.

\end{document}

