\documentclass[usegraphicx,usenatbib]{mn2e}
%\documentclass[useAMS,usegraphicx,usenatbib]{mn2e}

\usepackage{verbatim}
\usepackage{color}
\usepackage[normalem]{ulem} % for striking out with \sout
\usepackage{amsmath} % for boldsymbol
\usepackage{times}
\usepackage{mathabx}
\usepackage{enumitem}

\input{newcommands.tex}

\def\eps@scaling{1.0}% 

\newcommand{\sn}{$S/N$}
\newcommand{\Msn}{$(S/N)_{\textrm{matched}}$}
\newcommand{\Tsn}{$(S/N)_{\textrm{size}}$}
\newcommand{\fsn}{$(S/N)_{\textrm{flux}}$}

% stolen from the BA14 source
\newcommand{\vecg}{\mbox{\boldmath $g$}}
\newcommand{\vecD}{\mbox{\boldmath $D$}}
\newcommand{\vecQ}{\mbox{\boldmath $Q$}}
\newcommand{\matR}{\mbox{$\bf R$}}
\newcommand{\matC}{\mbox{$\bf C$}}
\newcommand{\bnabg}{ \boldsymbol{\nabla_g}}

\newcommand{\desreq}{$4\times 10^{-3}$}
\newcommand{\lsstreq}{$2\times 10^{-3}$}


\newcommand{\mnras}{MNRAS}%
\newcommand{\apj}{ApJ}%
\newcommand{\apjs}{ApJS}%
\newcommand{\aj}{AJ}%
\newcommand{\pasp}{PASP}%
\newcommand{\jcp}{J.~Chem.~Phys.}

\newcommand{\mcal}{metacalibration}
\newcommand{\Mcal}{Metacalibration}
\newcommand{\mcalR}{$R$}
\newcommand{\mcalRpsf}{$R^{p}$}
\newcommand{\mcalRpsfnoise}{$R^{p}_\eta$}
\newcommand{\mcalRo}{$R_o$}
\newcommand{\mcalRnoise}{$R_\eta$}

\newcommand{\mcalRmodel}{$R^{model}$}
\newcommand{\mcalRnoisemodel}{$R^{model}_\eta$}

%\slugcomment{Last revision \today}
%\shortauthors{Sheldon}
%\shorttitle{Bayesian Shear Estimation}


\title{Correction for Correlated Noise Effects in \Mcal\ Lensing Shear Estimation}

\author[Erin S. Sheldon]{Erin S. Sheldon\thanks{E-mail: erin.sheldon@gmail.com}\\
Brookhaven National Laboratory, Bldg 510, Upton, New York 11973}

\begin{document}

\maketitle

\begin{abstract}

I derive corrections for correlated noise effects in \mcal.   

\end{abstract}


\begin{keywords}                                                                    
    cosmology: observations,
    gravitational lensing: weak,
    dark energy
\end{keywords} 

\section{Introduction} \label{sec:intro}

\section{\Mcal} \label{sec:algo}

Suppose we have a biased shear estimator $E$.  We can expand this estimator
in a Taylor series around the true shear
\begin{align}
    E(\gamma) &= E(\gamma=0) + \gamma ~ \frac{ \partial E }{ \partial \gamma }\bigg|_{\gamma=0}  + ... \nonumber \\
      & \approx  \gamma ~ \frac{ \partial E }{ \partial \gamma } \bigg|_{\gamma=0}  \\
      & \equiv  \gamma ~ \mbox{\mcalR} \nonumber
\end{align}
where $\gamma$ is denotes the true gravitational shear.  We call \mcalR\
the shear response.

The essence of \mcal\ \citep{HuffMcal} is to estimate the shear response
\mcalR\ for a shear estimator $E$ directly from image data.  This is accomplished using
a numerical derivative.  The original image $I$ is de-convolved from the point
spread function (PSF), sheared, and re-convolved with a slightly larger PSF.  A
slightly larger PSF is used to suppress the amplified noise at high
frequency.  This \mcal\ process is repeated for a positive and negative
shear, which can be used to form a central derivative.  We can represent this
as a series of operations on the observed image $I$:
\begin{equation}
    I(\gamma) = I \Asterisk P^{-1} \oplus \gamma \Asterisk P_{d}
\end{equation}
where $\Asterisk$ represents convolution, $\oplus$ represents shearing,
and $P$ represents the point spread function.  De-convolution
is represented as ``inverse``, $P^{-1}$.  The slightly larger PSF, or
dilated PSF, is represented by $P_{d}$.

To form the central derivative we shear by a small positive and negative
amount $\gamma$
\begin{equation} \label{eq:Rnum}
    R = \frac{E(+\gamma) - E(-\gamma)}{2 \gamma}.
\end{equation}
The shear estimator can also be derived from the re-convolved
images
\begin{equation} \label{eq:estimator}
    E = \frac{E(+\gamma) + E(-\gamma)}{2}.
\end{equation}

For a constant shear, the response and shear estimators can be averaged
separately and combined to recover the mean shear:
\begin{equation}
    \gamma = \frac{ \langle E \rangle }{\langle \mbox{\mcalR} \rangle}.
\end{equation}
In \cite{HuffMcal} a more sophisticated inference was used, in order to deal
with the relatively large variance in \mcalR\ associated with the particular
estimator used therein.

\section{Contamination of the Response by Correlated Noise} \label{sec:contam}

In the presence of noise, the observed image can be written $I_o=I+\eta$, where $\eta$
is the ``noise image``.  The \mcal\ sheared images $I_o(\gamma)$ will contain
contributions from de-convolved, sheared and re-convolved noise:
\begin{align}
    I_{o}(\gamma) &= (I + \eta) \Asterisk P^{-1} \oplus \gamma \Asterisk P_{d} \nonumber \\
    &= I(\gamma) + \eta(\gamma).
\end{align}
The de-convolution correlates the noise
across the image.  This correlated noise is sheared, and then re-convolved by
the dilated PSF, producing the sheared correlated noise image $\eta(\gamma)$.

We expect the sheared correlated noise to partly cancel in the estimator in
equation \ref{eq:estimator}, because the effect is averaged over both positive
and negative shears. This quantity is further averaged over many galaxies.

However, the sheared correlated noise term will not cancel when calculating the
response, which is the difference of positive and negative shears.  This
remainder is amplified due to division by $2 \gamma$ to form the central
derivative.  We thus expect the observed response \mcalRo\ to be contaminated
by the response of the correlated, sheared noise \mcalRnoise\
\begin{equation}
    \mbox{\mcalRo}  =  R + \mbox{\mcalRnoise}
\end{equation}

\begin{comment}
\subsection{Expected Level of Contamination}

I think the following is not correct.

The correlated noise is produced by de-convolving and re-convolving by the psf,
so it may be correlated with the PSF ellipticity at some level.  Let's assume
the induced ellipticity is $f \times e^{PSF}$ in the absence of shearing, with
$f$ small.  We expect this to cancel in the response calculation, due to the
subtraction, but add to the estimator $E$.  This should, however, be
partly dealt with by subtracting $R^{PSF}$ (see below).

If we introduce shearing, then the sheared noise will cancel in the estimator
$E$ but not the response.

This sheared part of the correlated noise is suppressed by a factor of
$\gamma$, but in forming the derivative another factor of $1/\gamma$ is
applied.  Thus we expect the overall contamination $R_\eta$ to be of
the order $f \times e^{PSF}$.

\end{comment}

\section{Corrections for Correlated Noise} \label{sec:corr}

We propose to simulate the effects of the correlated noise on the measured
response.  We generate images with the right noise level and then measure the
response of this noise to a shear.  We then subtract the mean noise response
from the mean measured response, averaged over some set of galaxy images.

For shear estimators based on raw moments, without any form of iteration or
fitting, it would be sufficient to simply measure the moments of the resulting
sheared correlated noise field.

For shear estimators based on non-linear fitting, we propose the following
process:
\begin{enumerate}[label=\arabic*.]

    \item Measure the response without correlated noise
    
        \begin{enumerate}[label*=\arabic*.]
            \item Render the best fit model, including convolution by the point-spread
                function

            \item Perform the \mcal\ image processing steps, without noise added.

            \item Add an appropriate amount of noise to all images, using the
                same noise pattern $I_\eta$ for every image.

            \item Measure the response for this model \mcalRmodel.
        \end{enumerate}

    \item Measure the response with correlated noise
    
        \begin{enumerate}[label*=\arabic*.]
            \item Render the best fit model, including convolution by the point-spread
                function

            \item Add an appropriate noise pattern $I_\eta$ to the image, the
                same pattern used for measuring the response without correlated
                noise.

            \item Perform the \mcal\ image processing steps on this noisy
                image.

            \item Measure the response for this model \mcalRnoisemodel.

        \end{enumerate}

    \item Subtract the correlated noise response

\end{enumerate}

The measurement with correlated noise will be the sum of the response
without correlated noise plus the response of the correlated noise field
\begin{equation}
    \mbox{\mcalRnoisemodel} = \mbox{\mcalRmodel} + \mbox{\mcalRnoise}
\end{equation}
This measurement is quite noisy for a single galaxy, but we
can estimate the mean correlated noise response for an ensemble
of galaxies
\begin{equation}
    \langle \mbox{\mcalRnoise} \rangle = \langle \mbox{\mcalRnoisemodel} \rangle - \langle \mbox{\mcalRmodel} \rangle.
\end{equation}
Each entry used in this average corresponds to the best fit model
and noise properties for a galaxy in the sample.

The response \mcalRnoise\ can be subtracted to recover an estimate of the mean
response without correlated noise
\begin{equation}
    \langle \mbox{\mcalR} \rangle = \langle \mbox{\mcalRo} \rangle - \langle \mbox{\mcalRnoise} \rangle.
\end{equation}

\subsection{Corrections to \mcalRpsf}

A correction may also be calculated for the PSF response term, which is
calculated by shearing the PSF image instead of the galaxy image \citep{HuffMcal}
\begin{equation}
    \mbox{\mcalRpsf} = \frac{E(+\gamma^{p}) - E(-\gamma^{p})}{2 \gamma^{p}},
\end{equation}
where $\gamma^{p}$ is the shear applied to the PSF.  This
term adds to the estimator, multiplied by the PSF shape
\begin{equation}
    E = \mbox{\mcalR} \gamma + \mbox{\mcalRpsf} e^{p} 
\end{equation}
This term can be subtracted to approximately correct for additive PSF errors.

In calculating \mcalRpsf, the image is de-convolved and re-convolved by these
sheared PSFs. The noise is thus correlated by convolutions, but in slightly
different ways due to the differently sheared PSFs.  We thus do not expect this
effect to cancel in calculating \mcalRpsf. The resulting correlated noise
contamination term we may denote \mcalRpsfnoise.

We expect this correction to be sub-dominant to \mcalRnoise, as \mcalRpsfnoise\
is suppressed in the product $\langle$\mcalRpsfnoise$ \times e^{p}\rangle$.

\section{Application to Realistic Image Simulations}

\section{Cancellation in Ring Configurations}

This bias was not seen by \cite{HuffMcal} using the GREAT3 simulations
\citep{great3}.

The only substantial difference between the GREAT3 sims and our sims is that
GREAT3 galaxies were generated in a ``ring configuration''.  The simulation
included two identical images of each galaxy, rotated by 90 degrees with
respect to a one another, in order to cancel shape noise.

It is not clear to me that \mcalRnoise\ should cancel in a ring configuration,
unless the noise maps for the rotated galaxies were also identical and rotated.



\bibliographystyle{mn2e}
% Bib database
\bibliography{apj-jour,astroref}

\end{document}

