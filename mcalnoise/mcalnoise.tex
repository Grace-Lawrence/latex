\documentclass[usegraphicx,usenatbib]{mn2e}
%\documentclass[useAMS,usegraphicx,usenatbib]{mn2e}

\usepackage{verbatim}
\usepackage{color}
\usepackage[normalem]{ulem} % for striking out with \sout
\usepackage{amsmath} % for boldsymbol
\usepackage{times}
\usepackage{mathabx}
\usepackage{enumitem}

\input{newcommands.tex}

\def\eps@scaling{1.0}% 

\newcommand{\snr}{$S/N$}
\newcommand{\hlr}{$r_{50}$}

\newcommand{\uberseg}{{\"u}berseg}

% stolen from the BA14 source
\newcommand{\vecg}{\mbox{\boldmath $g$}}
\newcommand{\vecD}{\mbox{\boldmath $D$}}
\newcommand{\vecQ}{\mbox{\boldmath $Q$}}
\newcommand{\matR}{\mbox{$\bf R$}}
\newcommand{\matC}{\mbox{$\bf C$}}
\newcommand{\bnabg}{ \boldsymbol{\nabla_g}}

\newcommand{\desreq}{$4\times 10^{-3}$}
\newcommand{\lsstreq}{$2\times 10^{-3}$}


\newcommand{\mnras}{MNRAS}%
\newcommand{\apj}{ApJ}%
\newcommand{\apjs}{ApJS}%
\newcommand{\aj}{AJ}%
\newcommand{\pasp}{PASP}%
\newcommand{\jcp}{J.~Chem.~Phys.}
\newcommand{\aaps}{AASP}
\newcommand{\aap}{AAP}

\newcommand{\mcal}{metacalibration}
\newcommand{\Mcal}{Metacalibration}
\newcommand{\mcalR}{$R$}
\newcommand{\mcalRpsf}{$R^{p}$}
\newcommand{\mcalRpsfnoise}{$R^{p}_\eta$}
\newcommand{\mcalRo}{$R_o$}
\newcommand{\mcalRnoise}{$R_\eta$}

\newcommand{\mcalRmodel}{$R^{model}$}
\newcommand{\mcalRnoisemodel}{$R^{model}_\eta$}


\newcommand{\nsimNgal}{$10^8$}
\newcommand{\nsimNgaltwo}{$2 \times 10^8$}
\newcommand{\nsimNstar}{$10^7$}
\newcommand{\nsimNstarperc}{10\%}

\newcommand{\psfdist}{$(0.0,0.7) \pm 1.8$}
\newcommand{\rpsfdist}{$(0.0,0.0) \pm 1.8$}
%\newcommand{\psfdist}{$(0.0 \pm 1.8,0.7 \pm 1.8)$}
%\newcommand{\rpsfdist}{$(0.0 \pm 1.8,0.0 \pm 1.8)$}

\newcommand{\detrend}{de-trending}
\newcommand{\Detrend}{De-trending}


\newcommand{\Aslope}{$-1.11$}
\newcommand{\Rcorr}{$-0.0694$}
\newcommand{\rgbias}{$(-1.6 \pm 0.5) \times 10^{-3}$}

\title{Noise Effects in \Mcal\ Weak Lensing Shear Estimation}

\author[Erin S. Sheldon]{Erin S. Sheldon\thanks{E-mail: erin.sheldon@gmail.com}\\
Brookhaven National Laboratory, Bldg 510, Upton, New York 11973}

\begin{document}

\maketitle

\begin{abstract}

I implement corrections for sheared correlated noise effects in \mcal, and
explore the effects of stellar contamination and masking.   

\end{abstract}


\begin{keywords}                                                                    
    cosmology: observations,
    gravitational lensing: weak,
    dark energy
\end{keywords} 

\section{Introduction} \label{sec:intro}

\section{Metacalibration} \label{sec:algo}

Suppose we have a biased shear estimator $E$.  We can expand this estimator
in a Taylor series around the true shear
\begin{align}
    E(\gamma) &= E(\gamma=0) + \gamma ~ \frac{ \partial E }{ \partial \gamma }\bigg|_{\gamma=0}  + ... \nonumber \\
      & \approx  \gamma ~ \frac{ \partial E }{ \partial \gamma } \bigg|_{\gamma=0}  \\
      & \equiv  \gamma ~ \mbox{\mcalR} \nonumber
\end{align}
where $\gamma$ is denotes the true gravitational shear.  We call \mcalR\
the shear response.

The essence of \mcal\ \citep{HuffMcal} is to estimate the shear response
\mcalR\ for a shear estimator $E$ directly from image data.  This is
accomplished using a numerical derivative.  The original image $I$ is
de-convolved from the point spread function (PSF), sheared, and re-convolved
with a slightly larger PSF.  This \mcal\ process is repeated for a
positive and negative shear, which can be used to form a central derivative.
We can represent this as a series of operations on the observed image $I$:
\begin{equation}
    I(\gamma) = I \Asterisk P^{-1} \oplus \gamma \Asterisk P_{d}
\end{equation}
where $\Asterisk$ represents convolution, $\oplus$ represents shearing,
and $P$ represents the point spread function.  De-convolution
is represented as ``inverse'', $P^{-1}$.  The slightly larger PSF, or
dilated PSF, is represented by $P_{d}$.

To form the central derivative we shear by a small positive and negative
amount $\gamma$
\begin{equation} \label{eq:Rnum}
    R = \frac{E(+\gamma) - E(-\gamma)}{2 \gamma}.
\end{equation}
The shear estimator can also be derived from the re-convolved
images
\begin{equation} \label{eq:estimator}
    E = \frac{E(+\gamma) + E(-\gamma)}{2}.
\end{equation}

For a constant shear, the response and shear estimators can be averaged
separately and combined to recover the mean shear:
\begin{equation}
    \gamma = \frac{ \langle E \rangle }{\langle \mbox{\mcalR} \rangle}.
\end{equation}
In \cite{HuffMcal} a more sophisticated inference was used, in order to deal
with the relatively large variance in \mcalR\ associated with the particular
estimator used therein.

Another correction can be derived for errors in the correction for 
PSF anisotropy.  This correction involves shearing the PSF rather
than the galaxy:
\begin{equation}
    \mbox{\mcalRpsf} = \frac{E(+\gamma^{p}) - E(-\gamma^{p})}{2 \gamma^{p}},
\end{equation}
where $\gamma^{p}$ is a shear applied to the PSF.  This
term adds to the estimator $E$, multiplied by the PSF shape
\begin{equation}
    E = \mbox{\mcalR} \gamma + \mbox{\mcalRpsf} e^{p} 
\end{equation}
This term can be subtracted to approximately correct for additive PSF errors:
\begin{equation}
    \gamma = \frac{ \langle E \rangle - \langle \mbox{\mcalRpsf} e^{p} \rangle }{\langle \mbox{\mcalR} \rangle}.
\end{equation}
In practice we calculate mean responses, factoring out the response term:
\begin{equation}
    \gamma = \frac{ \langle E \rangle - 
            \langle \mbox{\mcalRpsf}\rangle \langle e^{p} \rangle }{\langle \mbox{\mcalR} \rangle}.
\end{equation}


\section{Contamination of the Response by Correlated Noise} \label{sec:contam}

In the presence of noise, the observed image can be written $I_o=I+\eta$, where $\eta$
is the ``noise image''.  The \mcal\ sheared images $I_o(\gamma)$ will contain
contributions from de-convolved, sheared and re-convolved noise:
\begin{align}
    I_{o}(\gamma) &= (I + \eta) \Asterisk P^{-1} \oplus \gamma \Asterisk P_{d} \nonumber \\
    &= I(\gamma) + \eta(\gamma).
\end{align}
The de-convolution correlates the noise
across the image.  This correlated noise is sheared, and then re-convolved by
the dilated PSF, producing the sheared correlated noise image $\eta(\gamma)$.

We expect the sheared correlated noise to partly cancel in the estimator in
equation \ref{eq:estimator}, because the effect is averaged over both positive
and negative shears. This quantity is further averaged over many galaxies.

However, the sheared correlated noise term will not cancel when calculating the
response, which is the difference of positive and negative shears.  This
remainder is amplified due to division by $2 \gamma$ to form the central
derivative.  We thus expect the observed response \mcalRo\ to be contaminated
by the response of the correlated, sheared noise \mcalRnoise\
\begin{equation}
    \mbox{\mcalRo}  =  R + \mbox{\mcalRnoise}
\end{equation}

A correction is also required for the PSF response term \mcalRpsf.  We find
this correction is similar in magnitude to the correction for \mcalR, although
it is somewhat suppressed in the final estimator due to multiplication by $e^p$.

\subsection{Expected Scaling of the Bias with Noise Level} \label{sec:scaling}

The bias in the ellipticity due to correlated noise should scale
with the noise correlation function, and thus the square of the noise level in
the image $n^2$ \citep{HirataCorrNoise}.  As stated above, this same bias will
propagate into the response.  We can write the observed \mcalRo\ as a contribution
from both the actual response \mcalR\ and a noise term \mcalRnoise\
\begin{align} \label{eq:scaling}
    \mbox{\mcalRo} &= R + \mbox{\mcalRnoise}  \nonumber \\
                   &= R + A n^2.
\end{align}

\section{Correction for Sheared, Correlated Noise} \label{sec:corr}

\begin{comment}
For shear estimators based on raw moments, without any form of iteration
or fitting, it would be sufficient to simply measure the moments of example
sheared correlated noise fields and subtract the mean response from the
responses measured on the real images.  Multiple realizations can be generated
for each galaxy to increase precision.
\end{comment}

The coefficient $A$ in Equation \ref{eq:scaling} can be calculated in simple
scenarios, as shown in \cite{HirataCorrNoise}.  However, the calculation is
more complex when forward-modeling the PSF, as we do in this work.

There are advantages to forward modeling which we would like to retain: the
noise in \mcalR\ using our forward-modeling approach is an order of magnitude
smaller than that seen for the re-Gaussianization approach in \cite{HuffMcal}.
In particular we find that applying smooth priors on the model parameters,
which is natural in a forward-modeling approach, stabilizes the fit and results in
a large reduction in variance.  This reduction in noise facilitates the simple
inference method outlined in \S \ref{sec:algo}.  The failure rate is also
dramatically decreased when applying smooth priors:  we find a failure rate of
$\sim$0.003\%, as opposed to $\sim$6\% for the re-Gaussianization code
implemented in the GALSIM package \citep{GALSIM2015}.  For these reasons we
explore a simple empirical correction in the following section.

%We outline some alternative methods in the appendix.

\subsection{Detrending the Correlated Noise Bias} \label{sec:detrend}

As mentioned in \S \ref{sec:scaling}, we expect the bias in \mcalR\ due to
correlated noise to scale with the square of the noise in the image $n^2$.  We
can add a small amount of noise to the image such that $n \rightarrow n +
\Delta n$. We then run the new image through the \mcal\ process, and measure
$R^{\mathrm{before}}$.
The response when adding noise before \mcal\ is given by
\begin{align}\label{eq:Rbefore}
    R_o^{\mathrm{before}} &= R + A (n + \Delta n)^2 \nonumber \\
       &\simeq R + A n^2 + 2 A n \Delta n
\end{align}
%&\simeq R + A n^2 + \frac{\partial (An^2)}{\partial n} \Delta n + ... \nonumber \\
where we have dropped terms of order $(\Delta n)^2$ and higher.  In equation
\ref{eq:Rbefore}, \mcalR\ is the response at noise $n+\Delta n$ in the absence
of correlated noise.  

We can also add identical noise {\em after} the original image  has been run
through \mcal, and measure $R^{\mathrm{after}}$.  The response when adding
noise after \mcal\ does not suffer any additional bias due to correlated noise:
\begin{align}
    R_o^{\mathrm{after}} &= R + A n^2.
\end{align}
The difference between these responses is then 
\begin{align}
    \Delta R &\equiv R_o^{\mathrm{before}} - R_o^{\mathrm{after}}  \nonumber \\
             &\simeq 2 A n \Delta n.
\end{align}

We propose the following procedure to correct for correlated noise:
\begin{enumerate}
    \item Calculate $\Delta R$ for a series of noise offsets $\Delta n$.
    \item Average $\Delta R$ over all objects for each noise offset.
    \item Perform a linear fit to $\Delta R$ vs. $2 n \Delta n$ to find the 
        coefficient $A$.
    \item Apply a mean correction for correlated noise given by
        \begin{align}
            \mbox{\mcalRnoise} & \simeq A n^2.
        \end{align}
        with a similar correction for \mcalRpsf.
\end{enumerate}
If the noise varies between observations, we can apply a 
correction based on the mean variance $A
\langle n^2 \rangle$.


\section{Image Simulations} \label{sec:sims}

\subsection{Parameteric Models}

We apply the de-trending correction scheme to a set of image simulations.  The
first simulations make use of parametric models, and are designed to be similar
to that used in \citet{bfd2015}.  The galaxies models were bulge+disk, with
offsets between the bulge and disk components, such that the total image
is not described by a single ellipse.  Both
components had the same ellipticity and half light radius \hlr. The \hlr\ were
drawn from a log-normal distribution centered at 2.0 pixels, with scatter of
0.5 pixels.  The bulges were offset in a random direction from the disk center, with
offsets drawn from a uniform distribution between zero and \hlr.  The
ellipticities were drawn from the simple model presented in \cite{ba14}
\begin{align}
    P(e) &\propto \left[1-(e)^2\right]^2 \exp\left[-e^2/2\sigma^2\right],
\end{align}
with $\sigma=0.2$.

We convolved the galaxy images with a PSF modeled as a Moffat profile
\citep{Moffat1969}, with \hlr\ = 1.5 pixels.  We drew the PSF shapes from a
distribution designed to match that measured in the Dark Energy Survey
\citep[][(DES)]{DESSVShear}.  The DES PSF shape distribution is well fit by a
double Gaussian with width 0.18 in each dimension, but with different mean for
$e_1$ and $e_2$.  For the first set of sims, ``BD'', we set the mean to
$(0,0)$.  For the second set ``BDMask'', we set the mean in $e_2$ to $0.007$,
matching that in DES, but leave the mean in $e_1$ zero in order to control for
the effects of masking (see below).

The S/N distribution, show in figure \ref{fig:s2n}, was also designed to match
the real DES galaxy catalog after ``good galaxies`` pre-selection
\citep{DESSVShear}, but with no explicit S/N cut applied based on the model
fitting. We adjust the distribution slightly to give a distribution with
mode $\sim10$.  Galaxies were sheared by 300 different randomly chosen
values, with amplitude chosen uniformly in the range 0.01 to 0.08, and uniform
random orientations.

\begin{figure}
    \centering
    \includegraphics[scale=0.45]{run-bd21mcal-dt01-s2n-hist.eps}

    \caption{Distribution of S/N in the Bulge+Disk simulations. The
    left panel is a zoom-in around the mode.  The right panel is
the full distribution of $\log_{10}(S/N)$}

\label{fig:s2n}
\end{figure}


Ideally, the \mcalR\ measured for stars should be consistent with zero in the
mean, and thus not bias the ensemble shear estimate.  In order to test the
robustness of \mcal\ to stellar contamination, we included $\sim$\nsimNstarperc\ stars
in each simulation.  The stars were simply drawn as PSFs, with the same flux
distribution as used for the galaxies.

For the ``BDMask'' simulations, we masked parts of the data in order to mimic
certain effects in real images. Masking is important to test, because the
Fourier transforms used to perform the \mcal\ convolutions cannot accommodate
missing data.  In order simulate these effects realistically, we chose a sample
of real ``\uberseg'' masks used in Dark Energy Survey shear analysis
\citep{DESSVShear}.  These include masking of bad pixels, bad columns, and
masking for neighbors.  Pixels were masked for neighbors if they were closer to
the neighbor's SExtractor \citep{Bertin96} segmentation map than they were to
the central galaxy.  A random sample of $\sim 1200$ masks was selected to have
a masked fraction less than 30\%, to avoid extreme cases.  An example image and
mask are shown in figure \ref{fig:mask}.  Note our simulation did not include
actual neighbors, so we will only test our ability to deal with masked data,
not the efficacy of the masking strategy itself.

\begin{figure}
    \centering
    \includegraphics[scale=0.45]{DES0508-5540-uberseg-013916.eps}

    \caption{Example DES image cutout and \uberseg\ mask.  The black wedge in
the lower right masks a nearby object, and the vertical black stripe masks a
bad column. }

\label{fig:mask}
\end{figure}


\subsection{COSMOS Simulations}

The second set of simulations are similar to the real-galaxy simulations used
in GREAT3 challenge \citep{great3}, with galaxy images draw from
COSMOS data.  There are two important differences.
First, the galaxies are oriented randomly rather than being placed in a ring
configuration.  Using random orientations avoids cancellation of systematics such as
some selection effects \citep{DESSVShear}.  Second, the PSF has optical aberrations consistent with
those found in the Dark Energy Survey data \footnote{Aaron Roodman, private
communication}.  The atmospheric component is a Kolmogorov model with mean FWHM =
0.9 arscec.  Similar to GREAT3, the aberrations were varied as Gaussian around
a fiducial value. These root-mean-squared variations, in units of waves in the
Noll convention are given in table \ref{tab:aberr}.  The code used to generate
these simulations began as a fork of the GREAT3 public code base, and is freely
available online\footnote{https://github.com/esheldon/egret}.

\begin{table}
    \centering
    \caption{Root-mean-squared variation for the aberrations in the optical model,
        in units of waves in the Noll convention, derived 
    from Dark Energy Survey data. \label{tab:aberr}}
    \begin{tabular}{ | l | l | }
        Zernike Component  & RMS Variation \\
        \hline
        Defocus & 0.13 \\
        Astigmatism in Y & 0.13 \\
        Astigmatism in X & 0.14 \\
        Coma in Y & 0.06 \\
        Coma in X & 0.06 \\
        Trefoil in Y & 0.05 \\
        Trefoil in X & 0.06 \\
        Spherical & 0.03 \\

    \end{tabular}
\end{table}

In figure \ref{fig:cosmos} we show the distribution of measured \snr\ for the
COSMOS simulations.  The mode of the distribution is somewhat higher than that
of the parametric simulations, about 12 instead of 10.  Also shown is the
distribution of the half-light-radius \hlr, measured
from the \sersic\ model fits distributed with the COSMOS catalog as part
of the GREAT3 challenge.  The mean \hlr\ for these simulations
is about $1.8 \pm 0.8$, somewhat smaller than the
log-normal $2.0 \pm 0.5$ for the parametric simulations, but with a tail to larger
size.


\begin{figure}
    \centering
    \includegraphics[scale=0.45]{mcal-v14s01-s2n-and-r50.eps}

    \caption{Distribution of properties in the COSMOS real galaxy simulations. The
    left panel contains the distribution of measured S/N, while the right panel contains
    the distribution of half-light-radius from the cosmos catalog for the input
    galaxies.  Overplotted as a dot-dashed line is the input half-light-radius
    for the bulge+disk simulations.}

\label{fig:cosmos}
\end{figure}





\begin{table*}
    \centering
    \caption{Description of the image simulations.  The Bulge and Disk
        had the same ellipticity and \hlr, but were
        offset uniformly up to \hlr, in a random direction. The ``BDStar''
    simulation shared the same galaxy images with the ``BD'' simulation, but with additional star
images included.  The ``Mask'' simulation had masking for bad columns, bad pixels, and
neighbor galaxies drawn from DES imaging.  The PSF had \hlr=1.5 pixels, and the ellipticity was drawn from a 
double Gaussian with the specified mean and width in each dimension.  
For more details of these simulations, see \S \ref{sec:sims}.  \label{tab:sims}}
    \begin{tabular}{ | l | c | c | c | c | c | c | }
        Sim          & Galaxy Model & PSF Model & PSF Shape$\times 10^2$ & \# Galaxies & \# Stars    & Masking   \\
        \hline
        BD           & Bulge+Disk   & Moffat    & \rpsfdist     &  \nsimNgal   & None        & None      \\
        BDStar       & Bulge+Disk   & Moffat    & \rpsfdist     &  \nsimNgal   & \nsimNstar  & None      \\
        BDEllip      & Bulge+Disk   & Moffat    & \psfdist  &  \nsimNgaltwo   & None        & None      \\
        BDEllipMask  & Bulge+Disk   & Moffat    & \psfdist  &  \nsimNgaltwo   & None        & DES       \\
        %BDMask2    & Bulge+Disk   & Moffat    & \psfdist  &  \nsimNgal   & None        & DES       \\
        %BDMaskStar & Bulge+Disk   & Moffat    & \psfdist  &  \nsimNgal   & \nsimNstar  & DES      \\
        RG           & COSMOS      & DES Optical & Optical Variations &  \nsimNgal   & None        & None      \\
    \end{tabular}
\end{table*}


\section{Results} \label{sec:detrendsim}

\subsection{Measurements of the Correlated Noise Effect}

The images were fit with a single Gaussian galaxy model and Gaussian PSF model.
Naively using these simple galaxy and PSF model results in a large model bias,
and large uncorrected PSF anisotropy.

A maximum likelihood fit was used, with smooth priors on all parameters to
produce a stable fit.  These priors were not tuned to the true galaxy
parameters; priors on flux and size were deliberately wider than truth by 20\%,
and that on ellipticity used $\sigma=0.3$ instead of the true $0.2$.  We
furthermore expect large {\em ordinary} noise bias at these low S/N levels.

The measurement of $\Delta R$ vs $2 n \Delta n$, for the RG simulation, is
shown in figure \ref{fig:detrend}.  The trend is well-fit by a linear model, as
expected, with a slope $A \simeq $\Aslope, implying a correction $A n^2 \simeq$
\Rcorr\ for this simulation.

\begin{figure}
    \includegraphics[scale=0.45]{mcal-v14s01-Rnoise-detrend-R11.eps}

    \caption{Trend of $\Delta R_{1,1}$ with $2 n \Delta n$ for the
        real galaxy simulation.   $n$ is the
    original noise level and $\Delta n$ is the additional noise added.  The
    trend is linear as predicted.}

\label{fig:detrend}
\end{figure}

\subsection{Shear Recovery}

In table \ref{tab:results} we show for shear recovery in our simulations, with
and without applying \detrend\ correlated noise corrections.  Without
correction, the multiplicative bias $m$ is $\simeq$ 0.1 for all simulations.
For simulations with a net PSF anisotropy, we also found a significant
remaining additive bias.

\begin{table*}
    \centering
    \caption{\Mcal\ results for each image simulation.  Complex galaxy models
        and non-Gaussian PSFs were used in each simulation.  Significant
        portions of the images were masked.  A single Gaussian was used
    to fit both galaxy and PSF, resulting in significant multiplicative 
    bias $m$ and additive biases $c$.  Results with and without correction
    for correlated noise are shown.  \Mcal, with corrections for correlated noise,
    reduces multiplicative bias to $\lesssim 10^{-3}$, and reduces the additive
    bias by a factor of five.  
    Stellar contamination at the level of \nsimNstarperc\ increases
    the noise in the recovered shear by $\sim$5\% but does not introduce 
    a significant bias.  
    Our simple scheme to correct for masking is to
    replace the masked pixels with the value of the Gaussian model, which is generally
    a poor fit.  Our results suggest this method may bias the recovered shear low.
    For BDMask2 a double Gaussian PSF model was used, which we may expect reduce any biases, but
    more statistics are needed to detect improvement.
    \label{tab:results}}
    \begin{tabular}{ |l|  |c| c|r|r|  r|r|r|}
        \hline
        & & \multicolumn{3}{c}{Uncorrected} & \multicolumn{3}{c}{Corrected} \\
        %Sim & $m$ & $c_1 \times 10^4$ & $c_2 \times 10^4$ & $m \times 10^4$ & $c_1 \times 10^4$ & $c_2 \times 10^4$ \\
        Sim & PSF Model & $m$ & $c_1 \times 10^4$ & $c_2 \times 10^4$ & $m \times 10^{3}$ & $c_1 \times 10^4$ & $c_2 \times 10^4$ \\
        \hline
        BD              & 1 Gauss & $0.10 \pm 0.00$ & $-0.3 \pm 0.2$ & $0.2 \pm 0.2$    & $ 0.5 \pm 0.4$ & $-0.3 \pm 0.2$ & $0.2 \pm 0.2$  \\
        BDStar          & 1 Gauss & $0.12 \pm 0.00$ & $-0.3 \pm 0.3$ & $0.3 \pm 0.3$    & $ 0.5 \pm 0.5$ & $-0.2 \pm 0.2$ & $0.2 \pm 0.2$  \\
        BDEllip         & 1 Gauss & $0.10 \pm 0.00$ & $0.0 \pm 0.3$ & $-5.6 \pm 0.3$    & $-0.2 \pm 0.3$ & $0.2 \pm 0.2$ & $1.1 \pm 0.2$  \\
        BDEllipMask     & 1 Gauss & $0.10 \pm 0.00$ & $0.0 \pm 0.3$ & $-5.6 \pm 0.3$    & $-0.5 \pm 0.3$ & $0.0 \pm 0.2$ & $1.0 \pm 0.2$  \\
        %BDMask2         & 2 Gauss & $0.11 \pm 0.00$ & $-0.5 \pm 0.3$ & $-6.1 \pm 0.3$  & $-0.33 \pm 0.49$ & $-0.5 \pm 0.2$ & $0.9 \pm 0.2$  \\
        %BDMaskStar      & 1 Gauss & $0.12 \pm 0.00$ & $0.0 \pm 0.3$ & $-6.3 \pm 0.3$   & $-0.70 \pm 0.50$ & $0.0 \pm 0.3$ & $1.3 \pm 0.2$  \\
        RG              & 1 Gauss & $0.12 \pm 0.00$ & $-0.3 \pm 0.3$ & $0.0 \pm 0.3$      & $-1.6 \pm 0.5$ & $-0.3 \pm 0.3$ & $0.1 \pm 0.3$  \\
    \end{tabular}
\end{table*}

After applying correlated noise corrections, we found the multiplicative bias
to be consistent with zero within errors for the parameteric simulations. For
the real galaxy RG simulation we detect remaining multiplicative bias of
approximately \rgbias.  For the BDEllip parameteric simulations, which have a
net psf anisotropy, we still detected a small remaining additive bias, but it
was reduced by a factor of five in amplitied, as compared to results without
correlated noise corrections.

\subsection{Stellar Contamination} \label{sec:stars}

As indicated in table \ref{tab:sims}, for the ``Star'' type simulations, we
included an additional \nsimNstar\ stellar objects, drawn simply as a PSF with
noise added.  The results are shown in table \ref{tab:results} for the ``Star''
type simulations.  We find that a stellar contamination of 
\nsimNstarperc\ does not introduce any significant bias, but does
increase the uncertainty by $\sim$5\%.

\subsection{Masking Effects} \label{sec:masking}

In order to perform the Fourier transforms used for the \mcal\ convolutions, we
must replace any missing data due to masked pixel values.  In particular we
wish to avoid any artifacts in the transformed images that would mimic an
additional ``response'' to the applied \mcal\ shear.

As an baseline extreme case, we replaced the masked pixels simply with noise.
This resulted in few percent calibration biases.

A better alternative is to replace the missing data with the result of a model
fit.  We performed an initial maximum likelihood fit, before performing any
\mcal\ operations, and replaced the masked data with the value from the PSF
convolved model.  We used a Gaussian model for both PSF and Galaxy, which is a
poor representation of the data; we consider this a worst case scenario as a
model replacement. 

The results using the model replacement method are shown in table
\ref{tab:results} for the BDEllipMask simulation.  The measured bias did not
change significantly compared to the measurements on BDEllip, which is the
unmasked version of this simulation.


\subsection{Selection Effects} \label{sec:selection}

There are two main types of selection: detection effects and ordinary selection
effects.  Detection effects occur when placing a detection threshold, for
example a minimum S/N, which will preferably select galaxies with lower
ellipticity.  Ordinary selection on an initially unbiased detected sample can
induce additional bias via the same mechanism.

Determining detection effects requires prior information about the properties of
the galaxies in the sample, including those galaxies that do not exceed the detection
threshold.  Ordinary selection effects can in principle be determined without
prior information if the initial detections were unbiased, but unbiased
detection of faint galaxies is unlikely to be feasible.

To test selection effects, we make a series of cuts on S/N in the BD
simulation.  We use the ``round'' S/N definition in order to avoid the first
order effect \citep{DESSVShear}. As indicated in table \ref{tab:selresults},
these cuts lead to a monotonic change in the recovered shear, with a few
tenths of a percent bias for a $S/N > 20$ cut.

\begin{table*}
    \centering
    \caption{\Mcal\ results when applying selections on the signal-to-noise ratio (S/N) to the BD simulations. Selections
    were applied to an initially unbiased sample; i.e. no {\em detection}
    bias was present in the sample. \label{tab:selresults}}
    \begin{tabular}{ |l| r|r|r|  r|r|r|}
        \hline
        & \multicolumn{3}{c}{Uncorrected for Selection} & \multicolumn{3}{c}{Corrected for Selection} \\
        Selection & $m \times 10{^3} $ & $c_1 \times 10^4$ & $c_2 \times 10^4$ & $m \times 10^{3}$ & $c_1 \times 10^4$ & $c_2 \times 10^4$ \\
        \hline
        %$(S/N) > 5$    & $3.0 \pm 4.4$ & $-0.3 \pm 0.2$ & $0.2 \pm 0.2$ & $3.3 \pm 4.4$ & $-0.3 \pm 0.2$ & $0.2 \pm 0.2$  \\
        $(S/N) > 7.5$  & $-0.7 \pm 0.4$ & $-0.3 \pm 0.2$ & $0.2 \pm 0.2$ & $-0.6 \pm 0.4$ & $-0.3 \pm 0.2$ & $0.2 \pm 0.2$  \\
        $(S/N) > 10$   & $-1.5 \pm 0.5$ & $-0.3 \pm 0.2$ & $0.2 \pm 0.2$ & $-1.0 \pm 0.5$ & $-0.3 \pm 0.2$ & $0.2 \pm 0.2$  \\
        $(S/N) > 15$   & $-2.3 \pm 0.5$ & $0.0 \pm 0.3$ & $0.0 \pm 0.3$ & $-0.9 \pm 0.5$ & $0.0 \pm 0.3$ & $0.0 \pm 0.3$  \\
        $(S/N) > 20$   & $-2.7 \pm 0.6$ & $-0.3 \pm 0.3$ & $-0.2\pm 0.3$ & $-0.9 \pm 0.6$ & $-0.3 \pm 0.3$ & $-0.2 \pm 0.3$  \\
    \end{tabular}
\end{table*}

We implemented a simple correction based on our \mcal\ measurements.  We
sheared the population of ellipticities with a fake shear using the measured
responses \mcalR, and estimated the shear using our \mcal\ mechanism before and
after selection.  We then used the ratio of these numbers as a correction
factor.  We sow the results in table \ref{tab:selresults} in the ``Corrected
for Selection'' column.  This simple correction reduced the bias approximately
$10^{-3}$ in all cases.

In real data, a simple correction scheme like the above will probably require
prior information.  One approach would be to take deep imaging data and add
noise such that the distribution of $S/N$ for the galaxy sample is similar to a
shallower data set.  The noisy ellipticity measurements could then be sheared
artificially and selected as above to derive a correction.  Multiple noise
realizations could be used to increase the precision of the correction.


\subsection{Using a Random Subset To Calculate \Detrend\ Corrections}

Measuring the \detrend\ parameters requires extra computations, at least a
factor of three to fit the linear parameters given in \S \ref{sec:detrend}, and
a factor of four if an additional point is used to check for possible
non-linearity. These extra computations could be expensive for large surveys.  

However, the \detrend\ parameters are more precisely measured than the shear
itself.  Here we explore the precision of the recovered shear using smaller
subsets of the object catalog to measure the \detrend\ parameters, and
applying the corrections to the full sample.  In Table \ref{tab:subsets}
we show the shear recovery parameters for various subset sizes, for the
BD simulation described in \S \ref{sec:detrendsim}

\begin{table*}
    \centering
    \caption{Additional variance in the recovered shear 
        using different sized subsets to
        estimate the detrending corrections.  Values were obtained
        from 100 bootstrap samples. \label{tab:subsets}}
    \begin{tabular}{| c | c |}
        Subset Size & Extra Error \\
        \hline
        1\% & 4.4\% \\
        5\% & 0.8\% \\
        10\% & 0.3\% \\
    \end{tabular}
\end{table*}
%        1\% & 30\% \\
%        5\% & 13\% \\
%        10\% & 8\% \\


We find that a relatively small sample can be used to determine the correlated
noise correction.  Calculating the detrending terms for 10\% of the sample
leads to only 0.3\% extra variance in the recovered shear, and using 1\% of
galaxies leads to only 4.4\% increase in variance.

To calculate these numbers we have assumed the extra uncertainty is added
quadratically with the uncertainty measured using all galaxies to estimate the
\detrend\ parameters; e.g for the first row, we have added approximately 30\%
quadratically with the measured uncertainty, resulting in a net increase of
4.4\%.

It is important to use a truly random subset of the population to determine the
corrections, including a fair sample of stars and other contaminants, and a
representative amount of pixel level masking.  If a particular aggregate shear
measurement involves a selection, this selection must also be applied to the
random subset.

\section{Bias on GREAT3 Simulations}

The correlated noise bias was not seen by \cite{HuffMcal} using the GREAT3
simulations \citep{great3}.  At this time, we do not yet understand why this
was the case.  The correlated noise effect scales with the square of the noise,
and the simulations used for GREAT3 contain significantly higher S/N than
the simulations used here.  However, we found the correlated noise was still
detectable in simulations we ran with similar properties to GREAT3, with
correlated noise bias at the 2\% level rather than the 12\% we saw in our RG
simulations.  We checked that the code used to perform the metacal procedures
for the \cite{HuffMcal} work and ours give identical results.  We also ran the
re-gaussianization code on our simulations and saw the correlated noise
effect.

Another important difference between the GREAT3 sims and our sims is that
GREAT3 galaxies were generated in a ``ring configuration''.  The simulation
included two identical images of each galaxy, rotated by 90 degrees with
respect to a one another, in order to cancel shape noise.  However, we ran one
of our simulations in a ring configuration and saw the same level of correlated
noise bias.

\section*{Acknowledgments}

ES is supported by DOE grant DE-AC02-98CH10886.

We thank Aaron Roodman for providing the variation of the optical aberrations
measured in DES data.



\appendix

\section{Additional Correction Methods}

\subsubsection{Correction using GALSIM}

With guidance from the GALSIM developers, we attempted to use the GALSIM noise
isotropization and whitening functionality to correct the correlated noise.
Isotropization enforces four fold symmetry, introducing minimal extra noise,
and whitening completely whitens the image, introducing significant extra
noise. Neither of these methods had any noticeable effect on the correlated
noise bias.

\subsubsection{Adding a Sheared, Correlated Random Noise Field}

For this method, we generated example random noise fields $\tilde{\eta}$, sheared
with the opposite sign of those used in the \mcal\ procedure:
\begin{equation}
    \tilde{\eta}(-\gamma) = \tilde{\eta} \Asterisk P^{-1} \oplus (-\gamma) \Asterisk P_{d}.
\end{equation}
We added these noise images to the $I(\gamma)_o$ images to
statistically remove the effects of sheared, correlated noise:
\begin{equation}
    \tilde{I}(\gamma) = I_o(\gamma) + \tilde{\eta}(-\gamma),
\end{equation}
where $\tilde{I}(\gamma)$ is an approximation for the desired image
$I(\gamma)$.    We used these $\tilde{I}(\gamma)$
to measure the correct \mcal\ for a large population.

This procedure increases the noise by a factor of $\sqrt 2$.  Thus, both the
response and estimator should be measured on the $\tilde{I}(\gamma)$ images, so
that the response is representative of the correct noise level.  To reduce the
noise in the fits, multiple random fields can be generated and added to the
original image, and these can all then be fit simultaneously.  This will
improve the precision of the fit, at the cost of increased computation time.

In our tests, this method did not perform as well as the \detrend\ method; the
bias in the RG simulation was about twice as large. It may be that using many
random realization to mitigate the extra noise would improve performance, but
this would come with significant extra computing cost.  Without any strong
theoretical preference for this method, we did not pursue it any further.

\subsubsection{Simulating Models}

In this method, we generated model images with the correct noise level corresponding
to each real imag.  We then measured the response of the noise due to the
convolutions and shears used in \mcal, with noise added before and
after the \mcal\ procedure.

The measurement with correlated noise will be the sum of the response
without correlated noise plus the response of the correlated noise field
\begin{equation}
    \mbox{\mcalRnoisemodel} = \mbox{\mcalRmodel} + \mbox{\mcalRnoise}
\end{equation}
This measurement is quite noisy for a single galaxy, but we
can estimate the mean correlated noise response for an ensemble
of galaxies
\begin{equation}
    \langle \mbox{\mcalRnoise} \rangle = \langle \mbox{\mcalRnoisemodel} \rangle - \langle \mbox{\mcalRmodel} \rangle.
\end{equation}
Each entry used in this average corresponds to the best fit model
and noise properties for a galaxy in the sample.

The response \mcalRnoise\ can be subtracted to recover an estimate of the mean
response without correlated noise
\begin{equation}
    \langle \mbox{\mcalR} \rangle = \langle \mbox{\mcalRo} \rangle - \langle \mbox{\mcalRnoise} \rangle.
\end{equation}
These responses will be noisier than the original images, due to the
independent noise in both \mcalRo\ and \mcalRnoise.  To increase
precision, the procedure can be repeated for different noise fields
and averaged, at the cost of increased computation time.


\bibliographystyle{mn2e}
% Bib database
\bibliography{apj-jour,astroref}

\end{document}

