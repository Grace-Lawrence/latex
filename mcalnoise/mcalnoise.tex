%\documentclass[usegraphicx,usenatbib,referee,aas_macros]{mn2e}
%\documentclass[usegraphicx,usenatbib,referee]{mnras}
%\documentclass[a4paper,fleqn,usenatbib]{mnras}
%\documentclass[a4paper,fleqn,referee,usenatbib]{mnras}
%\pdfoutput=1

\documentclass[iop]{emulateapj}


% only needed for draft watermark
%\usepackage[
%    paperwidth=8.3in,
%    paperheight=11.7in,
%    left=0.5in,
%    right=0.5in,
%    top=1.5in,
%    bottom=1.0in,
%    hmarginratio=1:1]{geometry}

%\usepackage{draftwatermark}
%\SetWatermarkScale{5}
%\SetWatermarkLightness{0.8}


\usepackage{graphicx}
\usepackage{verbatim}
\usepackage{color}
\usepackage{xcolor}
\usepackage{amsmath} % for boldsymbol
\usepackage{enumitem}
\usepackage[colorlinks=true, citecolor=blue, urlcolor=blue, linkcolor=blue]{hyperref}


\input{newcommands.tex}

\def\eps@scaling{1.0}% 

\newcommand{\snr}{$S/N$}
\newcommand{\hlr}{$r_{50}$}
\newcommand{\hlrmean}{1.54}
\newcommand{\hlrwidth}{1.00}

\newcommand{\psffwhmmean}{3.660}
\newcommand{\psffwhmwidth}{0.377}

\newcommand{\nmasks}{1400}
\newcommand{\uberseg}{{\"u}berseg}

\newcommand{\vecg}{\mbox{\boldmath $\gamma$}}
\newcommand{\vest}{\mbox{\boldmath $e$}}
\newcommand{\est}{e}

\newcommand{\mcal}{\textsc{metacalibration}}
\newcommand{\Mcal}{\textsc{Metacalibration}}

\newcommand{\mcalR}{\mbox{\boldmath $R$}}
\newcommand{\mcalRscalar}{\mbox{$R$}}

\newcommand{\mcalRmean}{\mbox{\boldmath $\langle R \rangle$}}
\newcommand{\mcalRscalarmean}{\mbox{$\langle R \rangle$}}

\newcommand{\mcalRpsf}{$R^{p}$}
\newcommand{\mcalRpsfnoise}{$R^{p}_\eta$}
\newcommand{\mcalRo}{\mbox{\boldmath $R_o$}}
\newcommand{\mcalRnoise}{\mbox{\boldmath $R_\eta$}}

\newcommand{\mcalRmeanalpha}{\mbox{\boldmath $\langle R_\alpha \rangle$}}
\newcommand{\mcalRmeanbeta}{\mbox{\boldmath $\langle R_\beta \rangle$}}

\newcommand{\mcalRg}{\mbox{\boldmath $R_\gamma$}}
\newcommand{\mcalRS}{\mbox{\boldmath $R_S$}}
\newcommand{\mcalRgmean}{\mbox{\boldmath $\langle R_\gamma \rangle$}}
\newcommand{\mcalRSmean}{\mbox{\boldmath $\langle R_S \rangle$}}

\newcommand{\mcalRtwopt}{\mbox{\boldmath $R^{2pt}$}}
\newcommand{\mcalRtwoptmean}{\mbox{\boldmath $\langle R^{2pt} \rangle$}}


\newcommand{\mcalRmodel}{\mbox{\boldmath $R^{model}$}}
\newcommand{\mcalRnoisemodel}{\mbox{\boldmath $R^{model}_\eta$}}

\newcommand{\probe}{\mbox{$P(\vest_\alpha, \vest_\beta)$}}

\newcommand{\Itild}{\mbox{$\widetilde{I}$}}
\newcommand{\ntil}{\mbox{$\widetilde{\eta}$}}
\newcommand{\Ptil}{\mbox{$\widetilde{P}$}}
\newcommand{\Ptild}{\mbox{$\widetilde{P_d}$}}

\newcommand{\Ihat}{\mbox{$\hat{I}$}}


\newcommand{\nsimShear}{0.02,0.00}
\newcommand{\nsimNgal}{$10^8$}
\newcommand{\nsimNgalTwo}{$2 \times 10^8$}
\newcommand{\nsimNgalFour}{$4 \times 10^8$}
\newcommand{\nsimNgalBD}{$5.6 \times 10^9$}
\newcommand{\nsimNStar}{$5.6 \times 10^8$}
\newcommand{\nsimNstarperc}{10\%}
\newcommand{\starnoiseincrease}{$\sim 2-3$\%}

%\newcommand{\psfedist}{$(0.0,0.7) \pm 1.8$}
\newcommand{\nsimPSFShape}{$0.000,0.025$}

%\newcommand{\psfrdist}{log-normal $(3.66 \pm 0.38)$}
\newcommand{\psfrdist}{0.9}

\newcommand{\galrdist}{COSMOS Fits}
\newcommand{\cosmosrdist}{$1.8 \pm 0.8$}

%\newcommand{\cosmosname}{COSMOS 23.5}
\newcommand{\cosmosname}{COSMOS}

\newcommand{\detrend}{de-trending}
\newcommand{\Detrend}{De-trending}

\newcommand{\fixnoise}{\texttt{fixnoise}}

\newcommand{\ngmix}{\texttt{ngmix}}


\newcommand{\Aslope}{$-1.11$}
\newcommand{\Rcorr}{$-0.0694$}
\newcommand{\rgbias}{$(-1.6 \pm 0.5) \times 10^{-3}$}

\newcommand{\bdsim}{\texttt{BDK}}
\newcommand{\bdstar}{\texttt{BDK+Stars}}
\newcommand{\bdmask}{\texttt{Mask}}
\newcommand{\rgsim}{\texttt{RG}}
\newcommand{\pimprovement}{90}

\newcommand{\galsim}{\texttt{GALSIM}}
\newcommand{\balrog}{\texttt{BALROG}}
\newcommand{\bfd}{\texttt{BFD}}

\newcommand{\RR}{$\left<RR\right>$}
\newcommand{\RS}{$\left<RR_{S}\right>$}
\newcommand{\SSs}{$\left<R_{S}R_{S}\right>$}

%\renewcommand*\rmdefault{cmr}
%\usepackage{default}

%\title{Noise Effects in \Mcal\ Weak Lensing Shear Estimation}

%\author[Sheldon et al.]{Erin S. Sheldon$^1$, Eric M. Huff$^2$\\
%$^1$Brookhaven National Laboratory, Bldg 510, Upton, New York 11973\\
%$^2$Jet  Propulsion  Laboratory,  California  Institute  of  Tech-
%nology, 4800 Oak Grove Dr., Pasadena, CA 91109, USA}

   
%Matthew R. Becker$^2$ \\
%$^1$Brookhaven National Laboratory, Bldg 510, Upton, New York 11973\\
%$^2$Department of Physics, Stanford University, 382 Via Pueblo Mall, Stanford, CA 94305, USA}

\shorttitle{Practical Shear Measurement with Metacalibration}
\shortauthors{Sheldon and Huff}

\begin{document}

\title{Practical Shear Measurement with Metacalibration}

\author{Erin S. Sheldon}
\affil{Brookhaven National Laboratory, Bldg 510, Upton, New York 11973}
\and
\author{Eric M. Huff}
\affil{Jet  Propulsion  Laboratory,  California  Institute  of  Technology, 4800 Oak Grove Dr., Pasadena, CA 91109, USA}


%\author{
%Erin S. Sheldon,\altaffilmark{1}
%Eric M. Huff\altaffilmark{2}
%}
%\altaffiltext{1}{Brookhaven National Laboratory, Bldg 510, Upton, New York 11973}
%\altaffiltext{2}{Jet  Propulsion  Laboratory,  California  Institute  of  Tech-
%nology, 4800 Oak Grove Dr., Pasadena, CA 91109, USA}
 
%\maketitle

\keywords{
    cosmology: observations --- gravitational lensing: weak --- methods: observational
}

\begin{abstract}

\Mcal\ is a recently introduced method to accurately measure weak gravitational
lensing shear using only the available imaging data, without need for prior
information about galaxy properties or calibration from simulations.  The
method involves distorting the image with a small known shear, and
calculating the response of a shear estimator to that applied shear.  The
method was shown to be accurate in moderate sized simulations with relatively
high signal-to-noise galaxy images, and without significant selection effects.
In this work we introduce a formalism to correct for both shear response and
selection biases.  We also observe that, for relatively low signal-to-noise
images,  the correlated noise that arises during the \mcal\ process results in
significant bias, for which we develop a simple empirical correction.  To test
these new ideas, we use large simulations based on both parametric models and
real galaxies images, including tests with realistic point-spread-functions.
We introduce additional challenges that arise in real data, such as detection
thresholds, stellar contamination, and missing data.  We apply cuts on the
galaxy properties to induce significant selection effects.  Using our
formalism, we recover the input shear with an accuracy better than a part in a
thousand in all cases.

\end{abstract}

%\keywords{
%    cosmology: observations,
%    gravitational lensing: weak,
%    dark energy
%}
%\begin{keywords}                                                                    
%    cosmology: observations,
%    gravitational lensing: weak,
%    dark energy
%\end{keywords} 

\section{Introduction} \label{sec:intro}

Weak gravitational lensing is a fascinating phenomenon that has become a useful
tool for testing our theories of gravity, measuring the properties and
distribution of dark matter, and characterizing the accelerated expansion 
of the universe known as dark energy \citep[for a review, see][]{HoekstraJain2008}.

Light passing massive objects undergoes a deflection, and the amount of this
deflection depends on all the mass in the ``lens'', both luminous and dark.
The deflection distorts, or ``shears'', the observed shape of extended objects
such as galaxies, and this shear is spatially correlated.  By studying these
spatial correlations, one can infer the correlations in the mass that caused the
lensing. One can study these correlations at any place in the universe,
including the locations of galaxies \citep{Mandelbaum06}, clusters of galaxies
\citep{JohnstonLensing07}, voids \citep{MelchiorVoids2014}, and even
correlations without reference to any particular lensing objects
\citep{CFHTCosmicShear2013}.  Because the effect depends on the geometry of the
lens-source system as well as mass, the expansion history and growth of
structure can be inferred  and thus weak lensing is also sensitive to dark
energy \citep{HeymansTomography2013}.


Pioneered as a measurement technique in the 1980s and 1990s, weak lensing was
quickly recognized to be complimentary to more standard dynamical techniques
\citep{Tyson84}.  Because the effect is independent of the dynamical state of
the lensing mass, it can be used to study the distribution of mass in systems
that are far from equilibrium \citep{CloweDMProof06}.   And because the effect
can be measured nearly anywhere, it can be used to probe very large scales,
measuring the correlation between objects and large scale structure
\citep{SheldonLensing09}.

Thus far, progress in measurement has been limited by technical challenges, a
few of which we will outline below.  To set a scale of reference, the weak
lensing shear due to a foreground lens typically introduces correlations in the
shapes of background galaxies at the percent level.    We would like to measure
this percent level signal to approximately a part in a thousand in upcoming
imaging surveys \citep{HutererSystematics06}.

There have traditionally been two approaches to measuring shear from
galaxy images: measuring moments of the light distribution and fitting models.

In the model fitting approach, a parametric model is convolved by an estimate
of the point-spread function (PSF) of the atmosphere and instrument, and fit to
the galaxy surface brightness profile.  The shear estimator, the ``shape'' of
the galaxy, is then determined from the parameters of this model.  This method
is limited for two primary reasons: First, in order for the shear inference to
be accurate, the model must accurately reproduce the galaxy profile, before
noise and convolution by the PSF, which requires a large number of parameters.
If the model cannot sufficiently reproduce the galaxy the estimator is said to
exhibit ``model bias'' \citep{Bernstein2010}.  The second is the bias in the
non-linear model fitting caused by noise, which is significant for low
signal-to-noise (\snr) images, and is difficult to predict
\citep{HirataAlign04,Refreg12,Melchior12}.  This ``noise bias'' is made worse
if large number of model parameters are used in an attempt to accurately
represent the galaxy.

Due to these biases, model fitting methods require additional calibration.
There are no absolute calibration sources in the universe that we can use to
derive a calibration, so those fitting models often use image simulations for
calibration \citep[e.g.][]{Zuntz13,Miller13,KidsShear2016,Refregier13,Jee16}.
These simulations must include all the relevant details of the real universe in
order to provide an accurate calibration.  It has been suggested that model
biases can partly be alleviated without image simulations if a sufficiently
flexible statistical framework is used \citep{SchneiderProbshear2015}, but
this has not yet been demonstrated.

Another traditional shear measurement technique uses the second moments of the
galaxy light distribution, after correction for the effect of the point spread
function \citep[e.g.][]{ksb95,Bernstein2010}.  These methods can be made quite
accurate for high \snr\ galaxy images, with little model bias
\citep{Bernstein2010,Okura2016}.  However, these methods still suffer the
``noise bias'' found in model fitting methods, due to the non-linear fitting
involved with the measurement.  Without further development, these methods are
not accurate at the part in a thousand level.

Finally, selection effects can bias the recovered shear in both model fitting
and moment based methods, but the corrections are typically considered as
separate from the shear estimation, to be inferred as part of a calibration
based on simulations \citep{Jarvis2016,KidsShear2016}).

Methods have recently been developed to avoid some of these biases without
relying on calibration from simulations.  The method of \citep{Zhang2017}
involves measuring the weighted moments in Fourier space, after subtracting an
appropriate noise power spectrum to deal with noise effects, and deconvolving
the PSF.  No non-linear fitting is performed.  The shear is then estimated
either from the ratio of sums of these moments \citep{Zhang2015}, or the PDF of
the un-normalized moments is symmetrized in order to infer an applied shear
\citep{Zhang2017}.  The sum method was shown to be accurate, at the part in a
thousand level in challenging simulations, but with unacceptably high noise.
The PDF symmetrization method was shown to be more precise, but the simulations
used were not large enough to determine the accuracy of the method to the part
in a thousand level.  No formalism was yet proposed to deal with selection
effects. 

Another new approach is the Bayesian Fourier Domain (\bfd) method for shear
inference introduced by \cite{ba14} and further developed by \cite{bfd2016}.  A
rigorous Bayesian framework was presented, in which prior information on galaxy
images from much deeper data is included.  Un-normalized moments in
Fourier space are used as the basic data vector, avoiding non-linear fitting
issues.  \bfd\ is also the first method for which selection effects are
corrected for naturally in the formalism, without use of external
simulations.  The method was tested in \cite{bfd2016} using a challenging
simulation.  In that initial study, a bias of $\sim 2 \times 10^{-3}$ was
detected, falling just short of the part in a thousand target.  However, given
its rigorous foundation, it seems possible that the desired accuracy will be
achieved with further technical development.  The required prior information
from deep data should in principle be available to current and future surveys
\citep{DESWhitePaper,TakadaHSC2010,IvezicLSST08,Euclid2011,SpergelWFIRST2015}.


%The
%method was shown to be accurate in a highly controlled, and unrealistically
%simple numerical experiment using model fitting techniques \citep{Sheldon2014}.

\Mcal\ \citep{HuffMcal}, the subject of this work, is a new method designed to
calibrate standard shear estimators, without requiring significant prior
information about galaxy properties.  This is accomplished by introducing an
artificial shear to images, and calculating how the shear estimator responds to
the applied shear, addressing both model bias and noise bias.  \Mcal\ can in
principle be used to calibrate any shear estimator, including shapes derived
from model fitting or weighted moments.  A similar idea to \mcal\ was
introduced by \cite{Kaiser2000}, although the full equivalent of \mcal\ was not
implemented therein.

%A similar idea to \mcal\ was introduced by \cite{Kaiser2000}.  Much of the
%treatment therein was quite general, but the detailed calculations and examples
%focused on fast weighted second moment estimators; the full equivalent of
%\mcal\ was not implemented.  The focus in \citep{HuffMcal} is on generic image
%manipulations quickly performed with modern computers, which can be applied
%to any shear estimator. 


The \mcal\ technique was shown to be accurate in controlled simulations
\citep{HuffMcal}.  However, the simulations used in that study \citep[based on
those used in][]{great3} contained fairly high \snr\ galaxy images, and the
galaxies were relatively large compared to the PSF size.  In a real survey, the
images are dominated by small faint galaxies, many of which cannot be reliably
detected or measured.  Furthermore, due to the limited number of galaxies in
those simulations, the accuracy of the method could only be tested to about 3
parts in a thousand.  In this work we use a more challenging set of
simulations.

We will also address other difficulties that arise in real data.  During
estimation of a shear statistic, further selection beyond a simple detection
threshold is often required, such as cutting or binning based on galaxy
properties, which can cause significant selection biases.  We introduce a
formalism to deal with selection effects, for example cuts on \snr\ and galaxy
size, that are required for any practical analysis. 

In real images, stars cannot be perfectly removed from the sample of objects
used to measure shear. We will show that \mcal\ is robust to the presence of
stars in the sample if the PSF is well determined.

%There may also be missing data in the images, such as
%bad pixels or columns; for surveys with multiple dithered epochs these portions
%of the image can simply be ignored, but we show that for single images this
%missing data can be address sufficiently.

Finally, the \mcal\ procedure itself correlates the noise across the image,
which becomes a dominant source of error for low \snr\ galaxy images.  We
introduce a simple image-level correction for this correlated noise.

We show that, in all scenarios we tested, \mcal\ is indeed accurate to a part
in a thousand.

\section{Introduction to Metacalibration} \label{sec:mcal}

In this section we introduce the basic concepts of \mcal. We will derive the
full formalism for shear measurements in \S \ref{sec:formalism}.

Suppose we have a noisy measurement \vest\ that we wish to use for shear
estimation.  \vest\ may be some estimate of an objects two-component ellipticity
such that $\vest = (\est_1, \est_2)$.  We can expand this observable in a
Taylor series about zero shear
\begin{align} \label{eq:Eexpand}
    \vest &= \vest|_{\gamma=0} + \frac{ \partial \vest }{ \partial \vecg}\bigg|_{\gamma=0} \vecg  + ... \nonumber \\
          &\equiv \vest|_{\gamma=0} + \mbox{\mcalR}\vecg  + ...
\end{align}
where we have defined the shear response:
\begin{align}
    \mbox{\mcalR} &\equiv \frac{\partial \vest}{\partial \vecg} \bigg|_{\gamma=0}.
\end{align}
Note the derivative is also with respect to the two-component shear $\vecg$, making
\mcalR\ a $2 \times 2$ matrix:
%\[ \mbox{\mcalR} = \bigg( \begin{array}{cc}
%\frac{\partial e_1}{\partial \gamma_1} & \frac{\partial e_2}{\partial \gamma_1} \\
%\frac{\partial e_1}{\partial \gamma_2} & \frac{\partial e_2}{\partial \gamma_2} \end{array} \bigg).\]
%again
\[ \mbox{\mcalR} = \left( \begin{array}{cc}
\partial e_1/\partial \gamma_1 & \partial e_2/\partial \gamma_1 \\
\partial e_1/\partial \gamma_2 & \partial e_2/\partial \gamma_2 \end{array} \right).\]
We can use the ensemble mean of such measurements \vest, for
example measured from a population of galaxies, as a shear estimator.
Assuming the shear is small, we can drop terms of order $\gamma^2$ and higher, such
that
\begin{align}
    \langle \vest \rangle &= \langle \vest \rangle |_{\gamma=0} + \langle \mbox{\mcalR} \vecg \rangle + ... \nonumber \\
                          &\approx \langle \mbox{\mcalR} \vecg \rangle,
\end{align}
where we have also assumed the intrinsic ellipticities of galaxies are randomly
oriented such that $\langle \vest \rangle |_{\gamma=0} \sim (0,0)$.  If we have
estimates of \mcalR\ for each galaxy, we can form a weighted average:
\begin{align} \label{eq:rcorr}
    \langle \vecg \rangle &\approx \langle \mbox{\mcalR} \rangle^{-1}  \langle \vest \rangle \approx \langle \mbox{\mcalR} \rangle^{-1} \langle \mcalR \vecg \rangle.
\end{align}
Note the special case of constant shear, where $\gamma$ factors out of the
right hand side.

If the estimator \vest\ is unbiased, the mean response matrix \mcalRmean\
will be consistent with the identity matrix.  If \vest\ is a biased
estimator, \mcalRmean\ will deviate from the identity matrix,
and could have significant structure.


The essence of \mcal\ \citep{HuffMcal} is to estimate the shear response
\mcalR\ for a measurement \vest\ directly from image data.  The measurement of
the shear estimator \vest\ is repeated on sheared versions of the galaxy
image and these are used to form a finite-difference central derivative.
For component $i,j$ we can write
\begin{equation} \label{eq:Rnum}
    R_{i,j} = \frac{\est_i^+ - \est_i^-}{\Delta \gamma_j},
\end{equation}
where $\est^+$ is the measurement made on an image sheared by $+\gamma$,
$\est^-$ is the measurement made on an image sheared by $-\gamma$,
and $\Delta \gamma = 2\gamma$.

The shearing is accomplished via a series of image manipulations. The original
image $I$ is de-convolved from the point spread function (PSF), sheared, and
re-convolved by the another function to suppress the amplified noise due to
deconvolution.  This function should be slightly larger than the original PSF
in order to suppress Fourier modes exposed by the shearing, that were
previously hidden in the finite resolution of the original image.  We can
represent the series of operations clearly in Fourier space, where
convolutions are products and deconvolutions are divisions:
\begin{equation}
    \Itild(\gamma) = \left[ \left( \Itild/\Ptil \right) \oplus \gamma \right] \times \Ptild
\end{equation}
where \Itild\ and \Ptil\ are the Fourier transforms of the image and PSF.
\Ptild\ is the Fourier transform of the function with which the image
is re-convolved; we use the subscript $d$ to indicated the function
is ``dilated'' with respect to the original PSF.
Shearing is represented by $\oplus$.

Note for measurement of the shear estimator \vest, one should use an image
passed through these same image manipulations, but without any shear applied.
This ensures the same re-convolution function is used for the shear estimator
and the response measurements.

We find that the results are rather insensitive to the choice of applied shear.
We tested values in the range of 0.001 to 0.05 and did not see significant
changes in the results. We take $\gamma=0.01$.

In practice, the response matrices measured from each image can have
significant structure, but the average \mcalRmean\ is to good approximation
diagonal.  Thus, for a straight mean shear measurement the correction in
equation \ref{eq:rcorr} reduces to element-wise division.  However,
measurements such as tangential shear or pairwise two-point functions involve
projecting the ellipticities into different coordinate systems. The measurement
may require projection of the response matrix as well, which could require
using the full response matrix.

One might expect the response to be proportional to the identity matrix if
there is no preferred direction in the measurement process.  In the simulation
tests we will present in \S \ref{sec:sims}, we found the diagonal elements can
differ by as much as a few parts in a thousand due to the use of a strong PSF
anisotropy oriented along the diagonal of the image.

As mentioned, the estimator \vest\ can be noisy, but in principle when
averaging over a large ensemble of measurements the noise does not cause any
bias because \mcalRmean\ is very well determined (see \S \ref{sec:differences}).
However, when working with images the \mcal\ process itself
alters the noise in a coherent way,
requiring a correction (see \S \ref{sec:fixnoise}).


\subsection{PSF Anisotropy and Shear Inference}  \label{sec:differences}

If the PSF correction is not perfect, the leading term $\langle \vest
\rangle|_{\gamma=0}$ will not be zero.  \cite{HuffMcal} discussed another
response, the response of the measurement to the PSF ellipticity, to correct
this effect.  In this work we instead reconvolve the image by a circular
function, which removes most additive effects due to the PSF  (see \S
\ref{sec:modelfit}).

In \cite{HuffMcal} the simple averaging in equation \ref{eq:rcorr} did not work
well because the shape estimators used  therein were relatively noisy.  Instead a sophisticated
statistical method was developed to infer the shear.  For the estimator we use
in this work (see \S \ref{sec:modelfit}), the \mcalR\ are relatively well
measured, even for very low \snr\ galaxies, and the average \mcalRmean\ is very
well determined. We find that using simple averages in equation \ref{eq:rcorr}
are adequate to infer the correct shear. 


\section{Full Metacalibration Formalism} \label{sec:formalism}

%  ['%.1f' % (sqrt(2)*s,) for s in [7,10,13,16,19]]
%    ['9.9', '14.1', '18.4', '22.6', '26.9']

In this section we derive the full \mcal\ formalism, including selection
effects. First we introduce some notation:  In principle the estimator \vest\
can be any set of measurements from an image, but in what follows, we will,
without loss of generality, write the shear estimator \vest\ as a two component
ellipticity $\vest = (\est_1,\est_2)$.  We write the ellipticity measured from
a sheared image as $\vest^+$ and $\vest^-$, for measurements on positive and
negatively sheared images respectively.  We denote the selection probability as
$S$;  we can also make selections based on sheared parameters, which we denote
$S^+$ and $S^-$, the probability of selection after a positive or negative
shear is applied, respectively.

\subsection{Response for the Mean Shear} \label{sec:Rmean}

Suppose we which to use the mean ellipticity as an estimator for the
mean shear.  The mean ellipticity over a large ensemble can be written as 
\begin{align}
    \langle \vest \rangle = \int P(\vest)~\vest~d\vest,
\end{align}
where $P(\vest)$ is the probability distribution of \vest.  We choose to work
with continuous functions so that all derivatives are well defined, in
particular the derivative of the selection function that we introduce below.

Assuming each galaxy experiences a small shear, and that galaxy orientations
are random in the absence of shear, the mean ellipticity can be rewritten, to
leading order, as
\begin{align} \label{eq:basicR}
    \langle \vest \rangle \approx \int d\vest \frac{\partial P(\vest) \vest  }{\partial \vecg}\bigg|_{\gamma=0} \vecg ~ d\vest = \langle \mcalRg \vecg \rangle,
\end{align}
where we have ignored the perturbation of the normalization $\int d\vest P(\vest)$,
because it leads to terms that are second order or higher in the shear.  The
mean shear is thus weighted by a response matrix \mcalRg.  This is the same $2
\times 2$ response matrix discussed in \S \ref{sec:mcal}; we have added the
subscript $\gamma$ to differentiate this response from the selection response discussed
below.  If the \mcalRg\ are known, we can form a weighted average estimator
for the mean shear:
\begin{align}
    \left< \vecg \right> \approx \mcalRgmean^{-1} \left< \vest \right> \approx \mcalRgmean^{-1} \left< \mcalRg \vecg \right>.
\end{align}

We can calculate this mean response \mcalRgmean\ using quantities measured on
artifically sheared images, as discussed in \S \ref{sec:mcal}.  We will
approximate the derivatives using finite differences in the shear, such that
\begin{align} \label{eq:basicRfinite}
    \mbox{\mcalRgmean}  &= \int \frac{\partial P(\vest) \vest  }{\partial \vecg}\bigg|_{\gamma=0} d\vest
    \approx \int d\vest \left( \frac{ P^+ \vest_i^+ - P^- \vest_i^- }{\Delta \gamma_j}\right)  d\vest   \nonumber \\
    &= \frac{\langle \est_i^+ \rangle - \langle \est_i^- \rangle}{\Delta \gamma_j},
\end{align}
where we switched to component notation, such that
$i,j$ denotes derivative of the $i$-th ellipticity component with respect
to the $j$-th shear component.  In practice, this averaging is performed
over an ensemble of measurements for discrete objects. It is equivalent to
averaging the responses as measured for each object.

\subsubsection{Selection Effects for the Mean Shear}

Now consider a selection that modifies the distribution of the measurement
\vest.  We will write this selection function as $S(\vest)$, the
probability of selecting an object with ellipticity \vest, although the
selection may be indirect, for example a cut on \snr.  This selection function
could also represent some kind of weighting scheme that indirectly weights by
ellipticity.

After introducing a selection, the mean becomes
\begin{align}
    \langle \vest \rangle^S = \int S(\vest)~P(\vest)~\vest~d\vest.
\end{align}
We will assume the $\int d\vest P(\vest) S(\vest) = 1$, and continue to ignore
the higher order effect from changes in the normalization under shear.
Again, assuming a small shear, and that galaxy orientations are random in the
absence of shear, the mean ellipticity after selection can be rewritten, to
leading order, as
\begin{align}
    \langle \vest \rangle \approx \int d\vest \frac{\partial S(\vest) P(\vest) \vest  }{\partial \vecg}\bigg|_{\gamma=0}~\vecg~ d\vest = \langle \mcalR \vecg \rangle,
\end{align}
Thus, the mean shear in the presence of selections is also weighted by a
response term \mcalR, and this response now includes the
shear response as well as the effects of the selections.
The probability that an object is selected changes after it is sheared.
%  We can
%also form a weighted average shear estimate including selections
%\begin{align}
%    \left< \vecg \right> \approx {\mcalRmean^S}^{-1}\left< \vest \right>^S.
%\end{align}

This response with selections can be calculated using quantities measured on
artifically sheared images. It is useful to examine separately the response of
the estimator $\vest$ to a shear, and the response of selection effects to a shear:
\begin{align}
    \mcalRmean  &= \int \frac{\partial S(\vest) P(\vest) \vest  }{\partial \vecg}\bigg|_{\gamma=0} d\vest \nonumber \\
    &= \int \left[ S(\vest) \frac{\partial P(\vest) \vest}{\partial \vecg}\bigg|_{\gamma=0} +  P(\vest) \vest  \frac{\partial S(\vest)}{\partial \vecg}\bigg|_{\gamma=0} \right] d\vest
\end{align}
Note the first term is identical to the response in equation \ref{eq:basicR},
but now with selections applied.  As we will see, the second term represents the
response of selection effects to a shear.

We will again approximate the derivatives using finite differences in the shear.
Using the notation for measurements on sheared images, introduced
in \S \ref{sec:formalism}, we can rewrite the response as
\begin{align} \label{eq:Rmean}
    \mbox{\mcalRmean} &\approx
    \int d\vest \left [ S \left( \frac{ P^+ \est_i^+ - P^- \est_i^- }{\Delta \gamma_j}\right) + P \est_i \left( \frac{ S^+ - S^- }{\Delta \gamma}\right) \right] d\vest \nonumber \\
    &=\frac{\langle \est_i^+ \rangle^S - \langle \est_i^- \rangle^S}{\Delta \gamma_j} + 
\frac{\langle \est_i \rangle^{S+} - \langle \est_i \rangle^{S-}}{\Delta \gamma_j} \nonumber \\
       &\equiv \langle \mbox{\mcalRg} \rangle + \langle \mbox{\mcalRS} \rangle,
\end{align}
where $\langle \est^+ \rangle^S$ represents the mean of the
sheared ellipticity, with
selections based on the unsheared parameters, $\langle \vest \rangle^{S+}$
represents the mean of the unsheared ellipticities, with selection based on the
sheared parameters.
Thus the first term \mcalRgmean\ in equation \ref{eq:Rmean} is the average of
the shear responses measured for individual galaxies, the same as shown in
equation \ref{eq:basicRfinite}, but now with selections applied based on the
unsheared object parameters.  The second term \mcalRSmean\ calculates
how the mean ellipticity changes due to selections when measurements
are performed on sheared images, in other words how the selection effects
change under a shear.  We say \mcalRSmean\ represents the
response of the selection effects to a shear.



%The $\langle \vest^+ S \rangle$ represents the mean of the positively sheared
%ellipticities, with selection based on the unsheared parameters. The $\langle
%\vest^- S \rangle$ represents the mean of the negatively sheared ellipticities,
%with selection based on the unsheared parameters.


\setlist[enumerate]{leftmargin=5mm}

In order to calculate the desired weighted mean shear, one measures the
following:
\begin{enumerate}
	\item The mean ellipticity measured from unsheared images, selecting on
        measurements from unsheared images.   This is the mean shear estimator
		we wish to calibrate.
	\item The mean ellipticity measured from sheared images, selecting
        on measurements from unsheared images,  $\langle e^+ \rangle^S$, $\langle e^- \rangle^S$. Alternatively, form 
        responses for each galaxy \mcalRg\ and average those
    \item The mean ellipticity from unsheared images, selecting on measurements
        from positively and negatively sheared images $\langle e \rangle^{S+}$, $\langle e \rangle^{S-}$
\end{enumerate}

%In practice, we recommend storing all the sheared and unsheared measurements
%and perform separate selections and statistics on those values to compute any
%ensemble averages needed for a particular inference (see e.g. \S
%\ref{sec:Rtwopt} where these quantities are used differently).

%Similar corrections can be derived for the PSF response \mcalRpsf.  For these
%terms, the psf shape in the product $\mbox{\mcalRpsf} e^p$ should be calculated
%from the unsheared data.



\subsection{Response for 2-point Functions} \label{sec:Rtwopt}

We can extend this formalism to 2-point functions of the ellipticity also known
as shear-shear correlations.  In this type of measurement, the product of
ellipticites for objects or regions of sky separated by some finite distance is
averaged.  Because the mass causing the lensing effect is correlated, the
shears will be correlated as well. The 2-point function can thus be interpreted
to constrain the correlations in the mass.

We will write the 2-point function as
\begin{align}
    \xi &= \langle \vest_\alpha \vest_\beta \rangle \nonumber \\
        &= \int \mbox{\probe} \vest_\alpha \vest_\beta d \vest_\alpha d \vest_\beta
\end{align}
where the $\langle \vest_\alpha \vest_\beta \rangle$ indicates the mean
ellipticity product for pairs of objects at different locations, or two
separated regions of sky.  Including selection effects, this becomes
\begin{align}
    \xi &= \int \mbox{\probe} S_\alpha S_\beta \vest_\alpha \vest_\beta d \vest_\alpha d \vest_\beta
\end{align}
where the selections are independent on each object.  Note we have used
the shorthand $S(\vest_\alpha) \rightarrow S_\alpha$.

Adopting the symmetry assumptions used in \S \ref{sec:Rmean}, and additionally that
the mean shear is zero over a large area of sky used to measure
the 2-point function, the leading
term in the Taylor expansion is a second derivative
\begin{align} \label{eq:basictwopt}
\xi &\approx \int d \vest_\alpha  d\vest_\beta  \frac{\partial^2 S_\alpha S_\beta \mbox{\probe} \vest_\alpha \vest_\beta}{\partial \vecg_\alpha \partial \vecg_\beta}\bigg|_{\gamma=0}  \vecg_\alpha \vecg_\beta \nonumber \\
    &\equiv \left<  \mbox{\mcalRtwopt} \vecg_\alpha \vecg_\beta  \right>.
\end{align}
The next largest terms are of order $ \langle e_\alpha \rangle|_{\gamma=0} \gamma_\alpha^2$.
In equation \ref{eq:basictwopt} the
true correlation function has been weighted by a response \mcalRtwopt. The mean of this response
is given by
\begin{align} \label{eq:Rtwoptfull}
%    \mbox{\mcalRtwoptmean} = \left< \frac{\partial^2 \xi}{\partial \gamma_\alpha \partial \gamma_\beta}\bigg|_{\gamma=0} \right> = 
    \mbox{\mcalRtwoptmean}  = 
    \int d \vest_\alpha  d\vest_\beta  \frac{\partial^2 S_\alpha S_\beta \mbox{\probe} \vest_\alpha \vest_\beta}{\partial \vecg_\alpha \partial \vecg_\beta}\bigg|_{\gamma=0}.
\end{align}
If we know the response \mcalRtwopt, we can form an estimator for the correlation function
that takes the form of a weighted average:
\begin{align} \label{eq:twoptavg}
    \xi \approx  \mcalRtwoptmean^{-1} \langle \vest_\alpha \vest_\beta \rangle \approx \mcalRtwoptmean^{-1} \left<  \mbox{\mcalRtwopt} \vecg_\alpha \vecg_\beta  \right>.
\end{align}

Note the joint probability distribution \probe\ is not separable 
because the shear at each galaxy $\alpha$ is correlated with that at galaxy
$\beta$. However, assuming the shapes of galaxies are not correlated in the absence of
lensing, \probe\ is separable at zero shear such that $\mbox{\probe}|_{\gamma=0}
= P(\vest_\alpha)|_{\gamma=0} P(\vest_\beta)|_{\gamma=0}$.  The following identities
also hold:
\begin{align} \label{eq:identities}
    \frac{\partial \mbox{\probe}}{\partial \vecg_\alpha}\bigg|_{\gamma=0} &= P(\vest_\beta) \frac{\partial P(\vest_\alpha) }{\partial \vest_\alpha} \frac{\partial \vest_\alpha}{\partial \vecg_\alpha}\bigg|_{\gamma=0} \nonumber \\
    \frac{\partial^2 \mbox{\probe}}{\partial \vecg_\alpha \partial \vecg_\beta}\bigg|_{\gamma=0} &= \frac{\partial P(\vest_\alpha) }{\partial \vest_\alpha} \frac{\partial P(\vest_\beta) }{\partial \vest_\beta}  \frac{\partial \vest_\alpha}{\partial \vecg_\alpha} \frac{\partial \vest_\beta}{\partial \vecg_\beta}\bigg|_{\gamma=0}.
\end{align}
It then follows that the response can be completely factored such that
\begin{align} \label{eq:Rseparable}
    \int d & \vest_\alpha  d\vest_\beta  \frac{\partial^2 S_\alpha S_\beta \mbox{\probe} \vest_\alpha \vest_\beta}{\partial \vecg_\alpha \partial \vecg_\beta}\bigg|_{\gamma=0}  \nonumber \\
      & \approx \int d \vest_\alpha  \frac{\partial S_\alpha P(\vest_\alpha) \vest_\alpha}{\partial \vecg_\alpha}\bigg|_{\gamma=0} \int d\vest_\beta   \frac{\partial S_\beta P(\vest_\beta) \vest_\beta}{\partial \vecg_\beta}\bigg|_{\gamma=0} \nonumber \\
      &=  \mcalRmeanalpha \mcalRmeanbeta.
\end{align}

For cross-correlations, the separate mean responses given in equation
\ref{eq:Rseparable} are different and should be calculated as indicated.
For auto-correlations, these two responses \mcalRmeanalpha\ and
\mcalRmeanbeta\ are identical, and are each equal to the
response of the mean shear given in equation \ref{eq:Rmean}.  In
that case the response
of the two-point auto-correlation function is approximately given by
\begin{align}
    %\left< R^{2pt} \right> = \left< \frac{\partial^2 \xi}{\partial \gamma_\alpha \partial \gamma_\beta}\bigg|_{\gamma=0} \right> \approx \mbox{\mcalRmean}^2.
    %\left< \frac{\partial^2 \xi}{\partial \gamma_\alpha \partial \gamma_\beta}\bigg|_{\gamma=0} \right> \approx \mbox{\mcalRmean}^2.
    \left< R^{2pt} \right> \approx \mbox{\mcalRmean}^2.
\end{align}

Thus it may be sufficient when measuring two-point functions to calculate the
mean response for the ensemble of objects.  This is a reflection of the
assumption that \probe\ is separable at zero shear.  However, this
assumption may not hold in general if spatially correlated objects have
correlated shapes in the absence of lensing (see \S \ref{sec:IA}) or if
imperfections in image reduction and object identification cause
biases that depend on the local galaxy density (see \S
\ref{sec:summary}).

%As noted in \S \ref{sec:mcal}, the response matrix is to good approximation
%diagonal.  If the selections are also not direction
%dependent, the weighted average in equation \ref{eq:twoptavg} reduces
%to element-wise division by the square of the scalar mean response
%\begin{align}
%    \xi \approx \frac{\langle \vest_\alpha \vest_\beta \rangle}{\mcalRscalarmean^2}.
%\end{align}
%This approximation is useful for two point functions, in which shapes are
%typically projected along axes different from those used to measure the
%response.

In what follows we test the formulas for mean shear.  We will test the
response for 2-point functions in a future work.

\subsection{Remarks on Selections}

Selections that produce additive effects are not addressed in the above.  If a
circular re-convolution function used, as we will do (see \S
\ref{sec:modelfit}), then selections on object properties will not be
correlated with the PSF shape, by construction, and thus no net additive bias
will be introduced. Note, however, that pre-selections, for example detection
thresholds, will in general produce such biases.  We will test the importance
of pre-selections with image simulations below.


It is important that the selections be placed well above any detection
thresholds, such that, after shearing, detected objects can move into and out
of the selected sample.  If the selection were too close to a detection
threshold, some objects that should become detectable after
a shear would not be included.

In real data, a selection may directly or indirectly select the redshift of the
sources, which means the true shear will be different after selection, even in
the absence of selection biases.  This must be taken into account separately.
We will not treat this effect in what follows.

Note if the selection function $S(\vest)$ is a step function, the derivative of
$S(\vest)$ in \ref{eq:Rmean} will be infinite.  Thus one should avoid
placing threshold cuts directly on the ellipticities.  However, it should be
valid to place cuts on other observables, such as \snr, that will
result in a smooth selection on the ellipticity.


\subsection{Remarks on Intrinsic Alignments} \label{sec:IA}

In the above we assumed that \probe\ is separable at zero shear, but this
assumption breaks down for physically associated galaxies
\citep[e.g.][]{HirataIntrinsicAlign07}, an affect known as ``intrinsic
alignments'' \citep[IA; for a recent review, see][]{TroxelIAReview2015}.
Within the \mcal\ formalism, the non-separable nature of \probe\ can be partly
dealt with by calculating the full pair-weighted response in equation
\ref{eq:Rtwoptfull}, without the approximations leading to equation
\ref{eq:Rseparable}.  However, the signal itself will be biased by the presence
of IA.  A number of methods  have been proposed to correct for the
contaminating effect of IA in the shear \citep{TroxelIAReview2015}.  With
\mcal, we can include the correct shear
weighting that occurs due to the non-unity response of the shear estimate,
which should improve the accuracy of the corrections (see
\S \ref{sec:weighting}).


\begin{comment}
\subsubsection{Without the factorization}

We can expand this response as
\begin{align} \label{eq:twoptres1}
    \bigg< \frac{\partial^2 \xi}{\partial \gamma_\alpha \partial \gamma_\beta}&\bigg|_{\gamma=0} \bigg> =
          \int d e_\alpha  de_\beta  \biggl[S_\alpha S_\beta \frac{\partial^2 P_{\alpha\beta} e_\alpha e_\beta}{\partial \gamma_\alpha \partial \gamma_\beta}   \nonumber \\
         & + S_\alpha \frac{\partial S_\beta}{\partial \gamma_\beta} \frac{\partial P_{\alpha\beta} e_\alpha e_\beta}{\partial \gamma_\alpha}
         + S_\beta \frac{\partial S_\alpha}{\partial \gamma_\alpha} \frac{\partial P_{\alpha\beta} e_\alpha e_\beta}{\partial \gamma_\beta} \nonumber  \\
         & + \frac{\partial S_\alpha}{\partial \gamma_\alpha} \frac{\partial S_\beta}{\partial \gamma_\beta} P_{\alpha \beta} e_\alpha e_\beta \biggr]\bigg|_{\gamma=0}  \nonumber \\
     & \equiv  \mbox{\RR} + 2 \mbox{\RS} +  \mbox{\SSs}
\end{align}
where the trailing evaluation at $\gamma=0$ is meant to apply to all the
derivatives within the brackets. Note the second and third terms are equal
under swapping of the indices and thus can be combined.


%\begin{align} \label{eq:twoptres1}
%     \left < \frac{\partial^2 \xi}{\partial \gamma_\alpha \partial \gamma_\beta}\bigg|_{\gamma=0} \right> =
%         & \int d e_\alpha  de_\beta  \biggl[ \nonumber \\
%         & \frac{\partial S_\alpha}{\partial \gamma_\alpha} \frac{\partial S_\beta}{\partial \gamma_\beta} P_{\alpha \beta} e_\alpha e_\beta  \nonumber \\
%        & + S_\alpha \frac{\partial S_\beta}{\partial \gamma_\beta} \frac{\partial P_{\alpha\beta} e_\alpha e_\beta}{\partial \gamma_\alpha} \nonumber  \\
%        & + S_\beta \frac{\partial S_\alpha}{\partial \gamma_\alpha} \frac{\partial P_{\alpha\beta} e_\alpha e_\beta}{\partial \gamma_\beta} \nonumber  \\
%        & + S_\alpha S_\beta \frac{\partial^2 P_{\alpha\beta} e_\alpha e_\beta}{\partial \gamma_\alpha \partial \gamma_\beta}  \biggr]\bigg|_{\gamma=0} \nonumber \\
%        \equiv \left<SS\right> + 2 \left<SR\right> + \left<RR\right>
%\end{align}


The first term \RR\ in equation \ref{eq:twoptres1} represents the response of
the estimator to shearing of either object in the product.  The last term \SSs\
represents the effects of independent selections in each object.  The cross
term \RS\ represent the response to shearing in one object and selection in another.

We can compute these terms using the sheared measurements, and using selections
on sheared measurements. We can approximate the derivatives with
finite differences.  The first term can be written as
\begin{align}
    \mbox{\RR} = \int d e_\alpha  d e_\beta S_\alpha S_\beta & \frac{\partial^2 P_{\alpha\beta} e_\alpha e_\beta}{\partial \gamma_\alpha \gamma_\beta} \bigg|_{\gamma=0} \approx \nonumber \\
    \frac{1}{\Delta \gamma^2} \Bigl(  & \left< S_\alpha S_\beta e_\alpha^+ e_\beta^+ \right> - \left< S_\alpha S_\beta e_\alpha^+ e_\beta^- \right> \nonumber \\
                                    - & \left< S_\alpha S_\beta e_\alpha^- e_\beta^+ \right> + \left< S_\alpha S_\beta e_\alpha^- e_\beta^- \right> \Bigr)
\end{align}
Note the cross terms are equal.  Also note we can write the 
the finite difference derivative response term
for an individual object as
$R_\alpha = (e_\alpha^+ - e_\alpha^-)/\Delta \gamma$.
Because all terms are selected based on the unsheared
parameters, we can refactor this entire term as a cross-correlation
of the individual response terms
\begin{align}
    \mbox{\RR} \approx \langle S_\alpha S_\beta R_\alpha R_\beta \rangle.
\end{align}

We can follow the same procedure for the cross term \RS, expanding the
deriviatives as finite differences:
\begin{align}
    \mbox{\RS} = \int d e_\alpha  d e_\beta  2 S_\alpha \frac{\partial S_\beta}{\partial \gamma_\beta} & \frac{\partial P_{\alpha\beta} e_\alpha e_\beta}{\partial \gamma_\alpha} \bigg|_{\gamma=0} \approx \nonumber  \\
    \frac{2}{\Delta \gamma^2} \Bigl( & \left< S_\alpha S_\beta^+ e_\alpha^+ e_\beta \right> - \left< S_\alpha S_\beta^+ e_\alpha^- e_\beta \right> \nonumber \\
    & - \left< S_\alpha S_\beta^- e_\alpha^+ e_\beta \right> + \left< S_\alpha S_\beta^- e_\alpha^- e_\beta \right> \Bigr).
\end{align}
As discussed in \S \ref{sec:Rmean}, $S^+$ and $S^-$ mean selection on
quantities measured from positively sheared and negatively sheared images,
respectively.  This term can also be further simplified in terms of the
individual shear responses $R_\alpha$.
\begin{align}
    \mbox{\RS}  \approx 
    \frac{2}{\Delta \gamma} \Bigl( & \left< S_\alpha S_\beta^+ e_\beta R_\alpha \right> - \left< S_\alpha S_\beta^- e_\beta R_\alpha \right> \Bigr).
\end{align}
Calculation of \RS\ involves two cross-correlations, with one of
the catalogs selected on sheared or unsheared parameters.

The last term \SSs\ can be written as
\begin{align}
    \mbox{\SSs} = & \int d  e_\alpha  d e_\beta  \frac{\partial S_\alpha}{\partial \gamma_\alpha} \frac{\partial S_\beta}{\partial \gamma_\beta}  P_{\alpha \beta} e_\alpha e_\beta \bigg|_{\gamma=0} \approx \nonumber \\
    & \frac{1}{\Delta \gamma^2} \Big< \left(S_\alpha^+ - S_\alpha^- \right) \left(S_\beta^+ - S_\beta^- \right) e_\alpha e_\beta  \Big> = \nonumber \\
    & \frac{1}{\Delta \gamma^2} \Big( \left< S_\alpha^+ S_\beta^+ e_\alpha e_\beta \right> - 2 \left< S_\alpha^- S_\beta^+ e_\alpha e_\beta \right> + \left< S_\alpha^- S_\beta^- e_\alpha e_\beta \right>     \Big)
\end{align}
There are three separate measurements to be made for \SSs:  the first and
last are auto-correlations where selections are placed on the positively and
negatively sheared parameters, respectively.  The second is a cross correlation
between one catalog selected using positively sheared quantities, the other
using negatively sheared quantities.
\end{comment}


\section{Contamination of the Response by Correlated Noise} \label{sec:contam}

In the presence of noise, the observed image can be written $I_o=I+\eta$, where $\eta$
is the ``noise image''.  The \mcal\ sheared images $I_o(\gamma)$ will contain
contributions from de-convolved, sheared and re-convolved noise. Again working
in Fourier space, and using the notation introduced in \S \ref{sec:mcal}:
%\begin{align}
%    I_{o}(\gamma) &= (I + \eta) \ast P^{-1} \oplus \gamma \ast P_{d} \nonumber \\
%    &= I(\gamma) + \eta(\gamma).
%\end{align}
\begin{align}
    \Itild_o(\gamma) &= \left[ \left( \Itild/\Ptil + \ntil/\Ptil \right) \oplus \gamma \right] \times \Ptild  \nonumber \\
    &= \Itild(\gamma) + \ntil(\gamma).
\end{align}

The de-convolution correlates the noise across the image.  This correlated
noise is sheared, and then re-convolved by \Ptild, producing the
sheared correlated noise image $\eta(\gamma)$.  The pattern of this sheared
noise is coherent between the positively sheared and negatively sheared images.
The effect is small, but it is amplified due to division by $\Delta \gamma$ to
form the central derivative.  We thus expect the observed response \mcalRo\ to
be contaminated by the response of the correlated, sheared noise which
we will denote \mcalRnoise:
\begin{equation}
    \mbox{\mcalRo}  =  \mcalR + \mbox{\mcalRnoise}.
\end{equation}
For the simulations and fitting method employed in this work, we generally
found \mcalRnoise\ to be -5 to -10\%.

%It is useful to think in terms of the noise power spectrum.  For simplicity
%consider a circular PSF.  After deconvolution, division by the PSF in Fourier
%space, the power spectrum is no longer flat, but has contours that grow towards
%high k.  After the shear is applied, these contours are also sheared.
%Re-convolving by the PSF suppresses these contours, but due to the shearing
%this suppression is not perfect.  We dilate the PSF to reduce these effects,
%the dilation does not completely remove the effect. We also tried using a much
%larger PSF but the effect was not not reduced.


\subsection{Correction for Sheared, Correlated Noise} \label{sec:fixnoise}


We explored four different empirical corrections.  We describe our favored
method here; the others are described in appendix \ref{sec:altcorr}.

This method, which we refer to as ``\fixnoise'', is designed to statistically
cancel the effects of correlated noise caused by the \mcal\ procedure.  For each
image that was passed through the convolution and shearing steps, producing
an image $I(\gamma)_o$, we generated a random noise field
$\eta_r$, and applied the same operations but using a shear with
the opposite sign:
%\begin{equation}
%    \tilde{\eta}(-\gamma) = \tilde{\eta} \ast P^{-1} \oplus (-\gamma) \ast P_{d}.
%\end{equation}
\begin{equation}
    \widetilde{\eta}_r(-\gamma) = \left[ \left( \ntil/\Ptil \right) \oplus (-\gamma) \right] \times \Ptild  \nonumber \\
\end{equation}
We then added this image, in real space, to the $I(\gamma)_o$ image
\begin{equation}
    \hat{I}(\gamma) = I_o(\gamma) + \eta_r(-\gamma).
\end{equation}
The result, $\hat{I}(\gamma)$, is an approximation for the image
without correlated noise.
We used these $\hat{I}(\gamma)$ to measure the shapes and responses used in
shear recovery.  

This procedure necessarily increases the noise in the shear recovery.  For
faint galaxies, which dominate the sample, the shape measurement noise is
comparable to the intrinsic shape noise, so the increase in effective noise
a modest 20\%.  Furthermore, for correlation function measurements over
large scales, sample variance will dominate and this small increase in shape
noise will be unimportant.  Nevertheless, it is worthwhile to explore
alternative corrections that do not involve adding significant noise.

Because the noise is increased, it is important that both the response and
estimator should be measured on the $\hat{I}(\gamma)$ images, so that the
response is representative of the correct noise level.

%An alternative version of this method is to shear the noise exactly as the
%original image is sheared, but then rotate by 90 degrees before adding.  This
%version has the advantage of working even when the transformation between sky
%and image involves a shear of the coordinate system\footnote{M. Jarvis, private
%communication}. We will explore this method in a future work.

\section{Weighted Averages for Associated Parameters} \label{sec:weighting}

As discussed in \S \ref{sec:formalism}, if a shear estimator has
non-unity response, the mean shear (or 2-point function) is effectively
weighted.  If we know the responses we can form a weighted average.

When averaging associated quantities, such as redshifts, one should also weight
by these responses.  For example, a quantity $x$ should be averaged as
\begin{align}
    \left< x \right> = \frac{\sum_i R_i x_i}{\sum R_i}.
\end{align}
The responses are not scalar, but it is probably sufficient
to use the average of the two diagonal components of the $R$ matrix
for this purpose. One concern is that the measured $R$ values are not
strictly positive.  It is worth exploring whether this causes
any bias in real scenarios.

\section{Image Simulations} \label{sec:sims}

We applied \mcal\ to a set of image simulations.  We used two different
types of simulations, one based on parametric galaxies and another
based on real galaxy images.  Information about each simulation type
is give in table \ref{tab:sims}

\begin{table*}
    \centering

    %\scriptsize
    \begin{tabular}{ l c c c c c c c c}
		\tableline
        \rule{0pt}{3ex}Sim          & Galaxy Model      & Size \& Flux   & PSF Model   & PSF FWHM        & PSF shape     & Shear & \# Galaxies    & \# Stars     \\
                    &                   &             &             & [arcsec]        &               &       &               &             \\
		\tableline
		\tableline
        \rule{0pt}{3ex}\rgsim       & \cosmosname       & \cosmosname & Kolm./Opt.  & \psfrdist/Opt.  & Optical       &  Variable & \nsimNgal     & None            \\
        \bdsim       & Bulge+Disk+Knots  & \galrdist   & Moffat      & \psfrdist       & \nsimPSFShape &  \nsimShear & \nsimNgalBD & None            \\
        \bdstar      & Bulge+Disk+Knots  & \galrdist   & Moffat      & \psfrdist       & \nsimPSFShape &  \nsimShear & \nsimNgalBD & \nsimNStar       \\
		\tableline
    \end{tabular}

	\parbox{0.9\textwidth}{
		\caption{\begin{flushleft}Description of the image simulations.  For the \bdsim\
		simulations, the Bulge and Disk had independent ellipticities but the same
		half light radius \hlr.  The galaxy \hlr\ and flux were drawn from fits to the 25.2 mag.
		limited COSMOS sample.  Additionally, knots of ``star formation'' were added as
		point sources distributed as a random walk in the disk.  The \bdstar\
		simulation shared the same galaxy images with the \bdsim\ simulation, but
		with additional star images included.  For
		the \rgsim\ simulation, real COSMOS images were used for the galaxies. For
		the PSF, a  Kolmogorov atmospheric turbulence model was used, 
		plus contributions from an optical model matched to DES; the mean PSF size
		was approximately 0.9 arcsec. The PSF ellipticity is given in the ``reduced
		shear'' convention.
		\label{tab:sims}
		\end{flushleft}}
	}
\end{table*}

\subsection{Simulations with Parametric Models} \label{sec:bdsim}

We created an image simulation using complex parametric models.  We modeled
galaxies as a bulge and disk, with additional knots of star formation.  We
label this simulation Bulge+Disk+Knots (\bdsim). 

We used different, uncorrelated ellipticities for the bulge and disk
components, but gave both bulge and disk the same half light radius \hlr.
We drew the \hlr\ and flux from fits \citep{LacknerGunn2012} to the 25.2
magnitude limited sample from the COSMOS data
\citep{Scoville2007a,Scoville2007b}, as distributed with the \galsim\
simulation package \citep{GALSIM2015}.  In order to avoid repeating the exact
parameters, we interpolated the joint \hlr-flux distribution using a kernel
density estimate.

The ellipticities were drawn from the simple model used in \cite{bfd2016}
\begin{align} \label{eq:edist}
    P(e) &\propto \left[1-(e)^2\right]^2 \exp\left[-e^2/2\sigma^2\right],
\end{align}
with $\sigma=0.2$ for the disk and $\sigma=0.1$ for the bulge.  Note, we use
the ``reduced-shear'' style ellipticity, which differs by roughly a factor of
two compared to the ellipticity used in \citet{bfd2016}.

For the simulated knots of star formation, we distributed 100 point sources
according to a random walk starting at the disk centroid, with each point
taking 40 steps.  This random walk method was inspired by
\cite{Zhang2008FourierQuadI}\footnote{Our implementation
of the random walk galaxy is available as a \galsim\ object class \texttt{galsim.RandomWalk}}.
We then distorted this distribution using the same ellipticity assigned to the
disk; but note this does not result in a purely elliptical distribution of
point sources.  Only in the rare case of a pure bulge, or disk with no knots,
is the model purely elliptical.

The fraction of the flux in the bulge was drawn uniformly between zero and
unity.  The fraction of the disk flux assigned to knots of star formation
was then also chosen uniformly between zero and unity.  The resulting 
objects range from pure bulge, bulge+disk, pure disks, bulges+disk+knots, 
to pure knots. A model with pure knots resembles an irregular galaxy.

Finally, the entire composite bulge+disk+knots object was sheared with the same
shear, $\vecg = (0.02, 0.00)$.

We convolved the galaxy images with a PSF modeled as a Moffat profile
\citep{Moffat1969}, with $\beta=3.5$ and FWHM=0.9 arcsec. The PSF ellipticity
was set to $g_2 = 0.025$ in reduced shear units ($e_2 \sim 0.05$ in units of
distortion). 

These convolved objects were randomly offset from the image center by $\pm 0.5$
pixels, and rendered onto a 48 by 48 grid, with pixel scale 0.263 arcsec per
pixel. Constant Gaussian noise was added, with the same noise level used for
all images. 

In figure \ref{fig:parametricgals} we show some example simulated galaxies with
a range of parameters.  Here we have shown large models, much larger than the
PSF, in order to show detailed internal structure.

\begin{figure*}[p]
    \centering
    \includegraphics[]{example-gals-007.eps}

    \caption{Example simulated galaxy images.  Each image is a composite of a
    bulge and disk, plus knots of star formation.  The half light radius is the
    same for all components, while the fraction of light in each component
    varies.  In the upper left and upper right we show pure bulge and pure disk
    models, respectively.  In the lower left we show a disk with half the light
    in knots, and in the lower right we show a pure ``irregular'' galaxy
    composed entirely of knots.  Each model was convolved by a Moffat PSF
	and pixelized.  For demonstration purposes, we here show very
    large models to make the detailed structure visible; the galaxies used for
    our shear tests are typically much smaller than the PSF (see figure
	\ref{fig:psimhlrcompare}). }

	\label{fig:parametricgals}

\end{figure*}

In figure \ref{fig:psimhlrcompare} we show the distribution of \hlr\ for the
parametric galaxies, along with the \hlr\ for the PSF.  Note most objects had
\hlr\ significantly smaller than the PSF.

In figure \ref{fig:s2n} we show the distribution of \snr\ for the parametric
galaxies.   Shown are both the true input \snr\ and the distribution of true
\snr\ after applying a cut at {\it measured} \snr$ > 5$.  This ``true'' \snr\
is that calculated by \galsim, and is the maximal \snr\ based on the true
model \citep{Jarvis2016}.  The measured \snr\ is noisy and biased (see \S
\ref{sec:results}), being derived from a single-Gaussian model, so the cut
results in a smooth rolloff in the true \snr.

\begin{figure}
    \centering
    \includegraphics[width=\columnwidth]{run-bdj03mcal02-r50.eps}

    \caption{Distribution of half-light-radius \hlr\ in the parametric simulations.
        The solid line represents the distribution of input \hlr, drawn from fits
        to COSMOS data.  The dashed line represents the \hlr\ for objects that passed
		the initial $S/N > 5$ pre-cut.  The \hlr\ of the PSF is shown as the vertical dotted
        line.}

\label{fig:psimhlrcompare}
\end{figure}


\begin{figure}
    \centering
    \includegraphics[width=\columnwidth]{run-bdj03mcal02-s2n.eps}

    \caption{Distribution of S/N in the parametric simulations. The
    solid curve represents the true input distribution, the dashed curve 
	represents the objects that passed the initial cut on {\it measured}
    \snr$ > 5$. The measured \snr\ was biased and noisy,
    resulting in a smooth selection on true \snr.}

\label{fig:s2n}
\end{figure}

\subsubsection{Simulated Stars}

In order to test the robustness of \mcal\ to stellar contamination, we included
$\sim$\nsimNstarperc\ stars in the \bdsim\ simulation.  The stars were simply
drawn as PSFs, with the same flux distribution as used for the galaxies.  We
refer to the simulation with stars as \bdstar; the galaxies are identical to
those in the \bdsim\ simulation, but stars were then included in the analysis.

\begin{comment}
\subsubsection{Simulated Masking}

The Fourier transforms used to perform the \mcal\ convolutions cannot
accommodate missing data.  But in real data, ``bad pixels'' must be masked in
order to prevent biased measurements. For the FFTs, these masked pixels must be
replaced with some value that does not bias the shear recovery.

We created another set of simulations, called \bdmask, in which we masked
parts of the data in order to mimic certain effects in real images.  In order
simulate these effects realistically, we chose a sample of real bit mask planes
used in Dark Energy Survey shear analysis \citep{DESSVShear}.  These include
masking of bad pixels, bad columns, and other image artifacts.   We chose a random
random sample of \nmasks\ masks, after removing those for which a masked pixel
fell within 4 pixels of the image center.  An example image and mask are shown
in figure \ref{fig:mask}.

\begin{figure}
    \centering
    \includegraphics[width=\columnwidth]{DES2117+0126-bmask-021223.eps}

    \caption{Example DES image cutout and bitmask.  The vertical black stripe masks a
bad column. }

\label{fig:mask}
\end{figure}
\end{comment}

\subsubsection{Pre-selection} \label{sec:preselect}

In real data, detections with significance less than \snr$\sim 5$ can be
spurious, so in practice a threshold must be placed to produce what are
considered reliable detections.  Such a pre-selection can produce significant
selection biases.  A round object has higher \snr\ than if it were sheared, and
galaxies oriented in the same direction as the PSF have higher \snr\ than
ebjects otherwise oriented.  Thus a pre-selection will tend to alter the
distribution of ellipticities, which will bias the shear recovery.  In
particular, if this selection occurs before \mcal\ and object fitting, the
corrections for selection effects presented in \S \ref{sec:formalism} cannot be
used.

In the \bdsim\ simulation, we generated images with \snr\ as low as $\sim 2$, as
shown in figure \ref{fig:s2n}.  In order to test the effect of a pre-selection,
we did not perform the \mcal\ process on all images.  We applied a
pre-selection on objects with \snr$ > 5$, and these objects were removed
from the analysis.  Then, as discussed in \S \ref{sec:shear_recover}, we
applied further cuts on the \snr\ above this threshold in order to minimize the
bias due to removal of these galaxies.


\subsection{Real Galaxy Simulations} \label{sec:cosmosim}

We designed a second set of simulations to mimic the ``real-galaxy'' constant
shear simulations used in GREAT3 challenge \citep{great3}, using real galaxy
images drawn from 23.5 magnitude limited COSMOS data.  We generated 1000
different fields in which galaxies were given a constant shear ranging from
0.01 to 0.08, with random orientations.

We implemented two important changes as compared to GREAT3.  First, we oriented
the galaxies randomly, whereas in GREAT3 the galaxies were placed in pairs
rotated by 90 degrees, in order cancel shape noise.  Using paired galaxies has
the undesired effect of cancelling some biases that we want to explore
\citep{DESSVShear}.  Second, we used optical aberrations in the PSF designed to
match that seen in the Dark Energy Survey data\footnote{Aaron Roodman, private
communication}.  Similar to GREAT3, we varied the aberrations as Gaussian
random variables around a fiducial value. These root-mean-squared variations,
in units of waves in the Noll convention, are given in table \ref{tab:aberr}.
We used a Kolmogorov model for the atmospheric component, such that
the overall mean FWHM $\sim 0.9$ arcsec for 0.263 arcsec pixels.
Each galaxy was rendered onto a 48 by 48 pixel grid.
For this configuration there are
significant variations in the PSF ellipticity, but relatively little net
ellipticity across the entire ensemble of realizations.  The code used to
generate these simulations began as a fork of the GREAT3 public code base, and
is freely available online\footnote{\url{https://github.com/esheldon/egret}}.

\begin{table}
    \centering
    \begin{tabular}{  l  l  }
		\tableline
        \rule{0pt}{2ex} Zernike Component  & RMS Variation \\
        \tableline
        \tableline
        \rule{0pt}{2ex}Defocus & 0.13 \\
        Astigmatism in Y & 0.13 \\
        Astigmatism in X & 0.14 \\
        Coma in Y & 0.06 \\
        Coma in X & 0.06 \\
        Trefoil in Y & 0.05 \\
        Trefoil in X & 0.06 \\
        Spherical & 0.03 \\
		\tableline
    \end{tabular}

	\parbox{0.8\columnwidth}{
		\caption{\begin{flushleft}Root-mean-squared variation for the aberrations in the optical model,
			in units of waves in the Noll convention, derived 
		from Dark Energy Survey data. \label{tab:aberr}\end{flushleft}}
	}
\end{table}

In figure \ref{fig:cosmos} we show the distribution of measured \snr\ for the
COSMOS simulations, as well as for the bulge+disk+knots simulation
\bdsim.  Also shown is the distribution of the half-light-radius \hlr, measured
from the \sersic\ model fits distributed with the both the 23.5 COSMOS catalogs
used for this sim, and the 25.2 sample used for our parametric simulations
\citep{GALSIM2015}.

\begin{figure*}
%    \centering
	\begin{center}
%    \parbox{0.9\textwidth}{
    %\includegraphics[width=\columnwidth]{mcal-v14s01-s2n-and-r50-with-nsim.eps}
    \includegraphics[width=0.8\textwidth]{mcal-v14s01-s2n-and-r50-with-nsim.eps}

%    \parbox{0.9\columnwidth}{
%    \parbox{0.8\textwidth}{
		\caption{Distribution of properties in the COSMOS real galaxy simulations. The
		left panel contains the distribution of measured S/N, while the right panel contains
		the distribution of half-light-radius from the cosmos catalog for the input
		galaxies.  For comparison, the distributions for the bulge+disk+knots \bdsim\ simulations
		are overplotted as dashed lines.}
%}
	\end{center}
\label{fig:cosmos}
\end{figure*}


Note the parametric sims presented in \S \ref{sec:bdsim} used much fainter and
smaller galaxies than the \rgsim\ simulation.  Also note the \rgsim\ simulation
was relatively expensive compared to the parametric simulations, so we
generated fewer galaxies and did not implement any pre-selection.  We thus do
not expect the real galaxy simulation to be more challenging than the
parametric simulation in every aspect. We include it to directly test the
robustness of \mcal\ to special properties of real galaxies that may not appear
in our bulge+disk+knots simulation, and to test shear recovery using a more
realistic PSF.  


\section{Model Fitting and Metacalibration Operations} \label{sec:modelfit}

We fit the images with a single Gaussian model using the \ngmix\
code\footnote{\url{https://github.com/esheldon/ngmix}}.  To perform the fit we used an
implementation of the ``adaptive moments'' algorithm originally presented in
\cite{bj02}.   We applied no PSF correction.  We expect this estimator to
respond weakly to a shear, but we will measure this weak response using \mcal.

In order to correct for PSF anisotropy  we reconvolved by a symmetrized version
of the PSF. We created this PSF by adding the PSF image to itself, rotated by
90, 120, and 180 degrees.  This averaging can result in a Fourier space image
that is larger in some dimensions than the original, so we further shrunk
the symmetrized PSF in Fourier space.  The shrink factor was taken to be
$1+2*\delta$, where
\begin{align}
    %\delta = \frac{E}{0.5 (<x^2> + <y^2>)}
    \delta = \frac{E}{T/2}
\end{align}
Here $E$ is the maximum eigenvalue from the covariance matrix of the best-fit
Gaussian. This we divide by half the trace $T$, which is the mean extent of the
object.  For a purely elliptical PSF, a factor of $1+\delta$ would be
sufficient; we conservatively increase the factor to $1+2\delta$ in case the
Gaussian fit does not completely capture the asymmetries of the true PSF.

All \mcal\ image operations were performed using the \texttt{metacal} module
from \ngmix, which in turn uses \galsim\ to perform most image manipulations.
We used the correction for correlated noise as discussed in \S
\ref{sec:fixnoise}


\section{Results} \label{sec:results}

In what follows we will characterize the bias using the standard linear model
\citep[e.g.][]{great3} with multiplicative part $m$ and an additive part $c$,
such that
\begin{align}
	\left< \gamma_{meas} \right> = (1+m) \gamma_{true} + c.
\end{align}
For the \bdsim\ simulations, there was only one shear value (\nsimShear),
 and $m$ was determined from the first component and $c$ was determined from the
second.  For the \rgsim\ simulations, there were many different shears,
and the linear model above was fit.  We found the multiplicative
bias was the same in each component, so they were combined into
a single value.
In all cases the measured \snr\ is based on the best fit Gaussian model,
using same definition implemented in the GREAT3 simulations \citep{great3}.

\subsection{\Mcal\ Responses}

In figure \ref{fig:Rstars} we show the measured \mcal\ responses for the
\bdsim\  simulations.  Also shown is the response with the stars included in
the \bdstar\ sim.  The distribution of \mcalR\ is quite symmetric in the
absence of stellar contamination\footnote{We observed that forward modeling
methods, in which the model is convolved by the PSF, generally manifest
an asymmetric distribution of responses \mcalR. This however does not
generally bias the shear recovery.}.  We will discuss the affect of stars in \S
\ref{sec:stars}.

\begin{figure}
    \centering
    \includegraphics[width=\columnwidth]{R-bdj03-bdj03stars.eps}

    \caption{Distribution of \mcal\ responses for galaxies and stars in
    the \bdstar\ simulation.  Stars have mean response close to zero,
    and thus do not bias the overall shear calibration.}

\label{fig:Rstars}
\end{figure}



\subsection{Shear Recovery} \label{sec:shear_recover}


In table \ref{tab:results} we show results for shear recovery in each of our
simulations.  As was discussed in \S \ref{sec:preselect}, we applied a
pre-selection to the \bdsim\ simulation at \snr$ > 5$, which imposes a
selection bias.  We thus placed cuts at higher \snr\ than this threshold, so
that the corrections for selection effects presented in \S \ref{sec:formalism}
could be used accurately.  In this table we show results for \snr$ > 10$.  For
the \rgsim\ simulation we did not apply a pre-selection.


\begin{table}
    \centering
    \begin{tabular}{ l  ccc}
		\tableline
        \rule{0pt}{3ex}Sim    & $m$               & $c_1$            & $c_2$ \\
               & $[10^{-3}]$       & $[10^{-5}]$      & $[10^{-5}]$ \\
        \tableline
		\tableline
        %\rgsim & $+0.22 \pm 0.58$  & $+0.26 \pm 0.29$ & $+0.22 \pm 0.29$ \\
        \rule{0pt}{3ex}\rgsim & $0.22 \pm 0.58$  & $2.6 \pm 2.9$    & $2.2 \pm 2.9$ \\
        \bdsim & $0.03 \pm 0.31$  & -                & $-0.15 \pm 0.62$ \\
        \bdstar& $0.01 \pm 0.32$  & -                & $-0.08 \pm 0.63$ \\
		\tableline
    \end{tabular}

	\parbox{0.9\columnwidth}{
		\caption{\begin{flushleft}\Mcal\ results for each image simulation described in
			\S \ref{sec:sims} and table \ref{tab:sims}.  For each simulation,
			a cut was placed at signal-to-noise ratio \snr$ > 10$, and corrections were applied
			for selection effects (see table \ref{tab:results_sel} for more
			results on selections).  A single Gaussian was fit
		to the observed object, with no PSF correction applied.
		No multiplicative or additive bias was detected in any case. 
		Stellar contamination at the level of \nsimNstarperc\ increases
		the noise in the recovered shear by \starnoiseincrease\ but does not introduce 
		a significant bias.  
		\label{tab:results}\end{flushleft}}
	}

\end{table}

Using \mcal\ we found no significant multiplicative or additive biases.
Without applying the \mcal\ responses, the multiplicative bias $m$ was of order
50\% for all simulations.


%        \bdmask& $-496$      & $+0.09 \pm 0.10$ & $ 15.07 \pm 0.10$ & $-0.60 \pm 0.46$  & $-0.17 \pm 0.23$ & $0.73 \pm 0.23$  \\


\subsubsection{Results with Selection Effects}

In table \ref{tab:results_sel}, we show the results for different \snr\
threshold cuts in the \bdsim\ simulations.  We show the recovered bias with and
without corrections for selection effects.  These results are also shown
graphically in figures \ref{fig:s2nthresh} and \ref{fig:s2nthresh_nocorr}.  The
cuts were all placed above the pre-selection at \snr$ > 5$, to guarantee the
validity of the corrections.

\begin{table*}
    \centering
    \begin{tabular}{ l cc  cc}
        \tableline
       \rule{0pt}{3ex} & \multicolumn{2}{c}{Uncorrected for Selection}                      & \multicolumn{2}{c}{Corrected for Selection} \\
        Selection                   & $m$             & $c$            & $m$               & $c$  \\
                                    & $[10^{-3}]$     & $[10^{-5}]$    & $[10^{-3}]$       & $[10^{-5}]$ \\
        \tableline
        \tableline
\rule{0pt}{3ex} $\mbox{\snr} > 7 $ & $+15.55 \pm 0.34$ & $+0.80 \pm 0.68$ & $+0.55 \pm 0.34$ & $+0.79 \pm 0.67$ \\
$\mbox{\snr} > 10 $ & $+3.78 \pm 0.31$ & $-0.15 \pm 0.62$ & $+0.03 \pm 0.31$ & $-0.15 \pm 0.62$ \\
$\mbox{\snr} > 13 $ & $-1.46 \pm 0.31$ & $+0.27 \pm 0.63$ & $+0.03 \pm 0.31$ & $+0.27 \pm 0.63$ \\
$\mbox{\snr} > 16 $ & $-4.58 \pm 0.33$ & $+0.44 \pm 0.67$ & $+0.26 \pm 0.34$ & $+0.44 \pm 0.67$ \\
$\mbox{\snr} > 19 $ & $-8.33 \pm 0.36$ & $+0.17 \pm 0.73$ & $+0.05 \pm 0.37$ & $+0.18 \pm 0.73$ \\
        \tableline
    \end{tabular}

	\parbox{0.9\textwidth}{
		\caption{\begin{flushleft}\Mcal\ results for the \bdsim\ simulation with various
			cuts on signal-to-noise ratio \snr.   Results are shown with and without corrections
			for selection effects.
		\label{tab:results_sel}\end{flushleft}}
	}
\end{table*}

\begin{figure}[h]
    \centering
    %\includegraphics[width=0.6\textwidth]{mc-select-bias-thresh.eps}
    \includegraphics[width=\columnwidth]{mc-select-bias-thresh.eps}

    \caption{Multiplicative (upper panel) and
		additive bias (lower panel) in the \bdsim\ simulation after applying
        threshold selections in \snr.   
        The filled grey region represents the target accuracy. } 

\label{fig:s2nthresh}
\end{figure}


\begin{figure}[h]
    \centering
    %\includegraphics[width=0.7\textwidth]{mc-select-bias-thresh-with-nocorr.eps}
    \includegraphics[width=\columnwidth]{mc-select-bias-thresh-with-nocorr.eps}

	\caption{Same as the top panel of figure \ref{fig:s2nthresh}, but now
additionally showing the multiplicative bias without corrections for selection
effects.  The bias without correction for selection effects is represented as
red diamonds. The bias after correction for selection effects is represented as
blue circles.  The filled grey region represents the target accuracy. } 

\label{fig:s2nthresh_nocorr}
\end{figure}



We measured and corrected for a significant multiplicative selection bias in
each case.  These biases are generally well above our desired part in a
thousand accuracy.  We find we can correct for these biases accurately using
the \mcal\ formalism: the multiplicative bias was less than a part in a
thousand in all cases.  We did not find any additive selection biases, which
suggests our procedure of reconvolving by a symmetrized PSF was sufficient for
these simulations.


\begin{comment}
\begin{table*}
    \centering
    \caption{\Mcal\ results for the \bdsim\ simulation with various
        cuts on \snr.   Results are shown with and without corrections
        for selection effects.
    \label{tab:results_sel}}
    \begin{tabular}{ |l| |c| c|c|c|  c|c|c|}
        \hline
        & & \multicolumn{3}{c}{Uncorrected for Selection}                      & \multicolumn{3}{c}{Corrected for Selection} \\
        Selection                   & Fraction Kept & $m$             & $c_1$            & $c_2$            & $m$               & $c_1$            & $c_2$ \\
                                    &               & $[10^{-3}]$      & $[10^{-4}]$      & $[10^{-4}]$      & $[10^{-3}]$       & $[10^{-4}]$      & $[10^{-4}]$ \\
        \hline
        $\mbox{\snr} > 0$           & 1.00          & -                & -                & -                & $-0.91 \pm 0.19$  & $-0.04 \pm 0.09$ & $+0.17 \pm 0.09$  \\
        $\mbox{\snr} > 7$           & 0.83          & $+2.53 \pm 0.19$ & $-0.05 \pm 0.10$ & $0.93 \pm 0.10$  & $-0.15 \pm 0.19$  & $-0.05 \pm 0.10$ & $+0.17 \pm 0.10$  \\
        $\mbox{\snr} > 10$          & 0.60          & $+3.48 \pm 0.20$ & $-0.00 \pm 0.10$ & $0.81 \pm 0.10$  & $-0.10 \pm 0.20$  & $-0.00 \pm 0.10$ & $+0.15 \pm 0.10$  \\
        $\mbox{\snr} > 13$          & 0.46          & $+2.61 \pm 0.20$ & $+0.04 \pm 0.10$ & $0.58 \pm 0.10$  & $-0.09 \pm 0.20$  & $+0.04 \pm 0.10$ & $+0.13 \pm 0.10$  \\
        $\mbox{\snr} > 16$          & 0.39          & $+1.85 \pm 0.21$ & $+0.07 \pm 0.11$ & $0.49 \pm 0.11$  & $-0.04 \pm 0.21$  & $+0.07 \pm 0.11$ & $+0.14 \pm 0.11$  \\
        $\mbox{\snr} > 19$          & 0.33          & $+0.98 \pm 0.22$ & $+0.03 \pm 0.11$ & $0.42 \pm 0.11$  & $-0.23 \pm 0.22$  & $+0.03 \pm 0.11$ & $+0.12 \pm 0.11$  \\

        \hline

        $\mbox{\snr} \in [ 7,  16]$ & 0.44          & $+3.68 \pm 0.38$ & $-0.29 \pm 0.19$ & $1.70 \pm 0.19$  & $-0.37 \pm 0.38$  & $-0.29 \pm 0.19$ & $+0.22 \pm 0.19$  \\
        $\mbox{\snr} \in [16,  37]$ & 0.22          & $+4.55 \pm 0.33$ & $+0.12 \pm 0.17$ & $0.70 \pm 0.17$  & $-0.41 \pm 0.33$  & $+0.12 \pm 0.17$ & $+0.21 \pm 0.17$  \\
        $\mbox{\snr} \in [37,  87]$ & 0.10          & $+0.21 \pm 0.37$ & $-0.27 \pm 0.19$ & $0.04 \pm 0.19$  & $+0.14 \pm 0.37$  & $-0.13 \pm 0.19$ & $-0.17 \pm 0.19$  \\
        $\mbox{\snr} \in [87, 200]$ & 0.04          & $-2.00 \pm 0.52$ & $-0.04 \pm 0.26$ & $0.81 \pm 0.26$  & $+0.22 \pm 0.52$  & $-0.04 \pm 0.26$ & $+0.61 \pm 0.26$  \\

        %$\mbox{\snr} \in [7, 10.84]$      & 0.27     & $-0.37 \pm 0.55$ & $-0.38 \pm 0.27$ & $1.78 \pm 0.27$  & $-0.11 \pm 0.55$  & $-0.38 \pm 0.27$ & $0.27 \pm 0.27$  \\
        %$\mbox{\snr} \in [10.84, 22.73]$  & 0.27     & $+7.44 \pm 0.37$ & $-0.03 \pm 0.18$ & $1.16 \pm 0.18$  & $-0.41 \pm 0.37$  & $-0.03 \pm 0.18$ & $0.09 \pm 0.18$  \\
        %$\mbox{\snr} > 22.73$          & 0.27     & $+0.47 \pm 0.23$ & $+0.05 \pm 0.12$ & $0.46 \pm 0.12$  & $-0.02 \pm 0.23$  & $+0.05 \pm 0.12$ & $0.20 \pm 0.12$  \\


    \end{tabular}
\end{table*}
\end{comment}




%\begin{figure}
%    \centering
%    %\includegraphics[width=0.9\textwidth]{mc-select-bias-range.eps}
%    \includegraphics[width=\columnwidth]{mc-select-bias-range-pyx.eps}

%    \caption{Bias in the \bdsim\ simulation after applying
%        range selections in \snr.  The left panel represents
%        the multiplicative bias $m$ and the right panel the additive
%        bias $c$.  The bias without correction for
%        selection effects is represented as as red diamonds. The bias after
%        correction for selection effects is represented as blue circles.  } 

%\label{fig:s2nrange}
%\end{figure}



\subsubsection{Results with Stellar Contamination} \label{sec:stars}

Results including \nsimNstarperc\ stars in the \bdstar\ simulation are shown in
table \ref{tab:results}. We did not detect any additional bias after including
stars. The noise in the recovered shear did, however, increase by
\starnoiseincrease.

%As indicated in table \ref{tab:sims}, for the \bdstar\  type simulations, we
%included an additional \nsimNStar\ stellar objects, \nsimNstarperc, drawn
%simply as a PSF with noise added.  The galaxy images were the same as used in
%the \bdsim\ simulation.  The results are shown in table \ref{tab:results}.  

\Mcal\ is robust to stellar contamination if the PSF is well
characterized.  Images consistent with a PSF will not, in the mean, respond to the shear
applied during the \mcal\ process.  Measurement on stars also yields zero average shape, as
long as the PSF correction is sufficiently accurate: our use of a symmetrized
PSF (see \S \ref{sec:modelfit}) appears to be sufficient in this case.
In figure \ref{fig:Rstars} we show the measured response \mcalR\ for stars and
galaxies.  Indeed we see that, for stars, the \mcalR\ is noisy but consistent
with zero.

If the additional variance is tolerable, it may be useful to include stars in a
shear analysis if the PSF is sufficiently well known.  Attempting to remove
faint stars from a sample is a noisy procedure, likely to induce selection
effects.  These can be controlled using the corrections derived in \S
\ref{sec:formalism}, but only if the selection is also repeated based on
quantities measured on sheared images, so the corrections can be calculated.
If the selection must be performed outside of the \mcal\ process, it may be
better to avoid it altogether.

For accurate interpretation of the signal, it is still important that any
redshift estimates for the stars are consistent with zero, in the mean. It is
also important to weight by the \mcal\ response terms in order to get the
correct redshift distribution; see \S \ref{sec:weighting} for more
discussion of weighted means.




\subsubsection{Effects of Missing Data}

The Fourier transforms used to perform the \mcal\ convolutions cannot
accommodate missing data.  But in real data there are features in the image,
such as bad pixels and columns, and cosmic rays that cannot be used for object
measurement.  This can be dealt with easily when the galaxy model is fit
simultaneously to postage stamps drawn from all available observing epochs and
bands \citep[e.g.][]{Jarvis2016}.  If the epochs are spatially offset, such
that the object does not always appear at the same location in the image, then
a small fraction of images should be affected by missing data such as bad
pixels.  In that case, epochs with missing data can simply be left out of the
fit.

If only a single image is available, one may want to replace the missing data.
To test this scenario, we chose to replace the missing data with the value from
the best fit Gaussian model.  Using a better model would be preferred; this may
be considered a worst case scenario.

We ran a simulation in which 10\% of the images had bad pixels or bad columns.
We found the model replacement worked well for single bad pixels. For bad
columns we found a large additive $e_1$ bias, as well as a multiplicative bias
of a few parts in a thousand.  However, this bias disappeared if we introduced
a compensatory ``bad column'' at 90 degree rotation about the center of the
image, restoring symmetry to the image. 

\section{Weak Shear Approximation}

In deriving the response terms in \S \ref{sec:formalism}, we assumed the shear
was small, so that the response of the estimator to a shear was linear in. This
approximation will break down at higher shears.  We expect
the multiplicative bias to have the following generic form \citep{bfd2016}:
\begin{align} \label{eq:breakdown}
	B(\gamma) = m + \alpha \gamma^2 + O(\gamma^4)
\end{align}

We tested the bias from non-linearity using both the \bdsim\ image
simulations and a ``toy model'', inspired by that used in \citep{ba14}.
For the image simulations, we ran additional tests with shears of
0.06 and 0.10, in addition to the 0.02 discussed above.

For the toy model we drew ellipticities from the distribution given in equation
\ref{eq:edist} and added constant shear analytically using the standard shear
transformation equations \citep{SeitzSchneider97}.  We then multiplied by a
bias factor of 0.6, and added Guassian noise to each ellipticity component with
scatter of 0.2. We truncated the total ellipticity to be less than unity,
making the noise effectively non-Gaussian.  We performed \mcal\ operations by
analytically shearing the shapes.  Note we did not shear the noise, so sheared
noise effects as seen in the image simulations are not present.

In figure \ref{fig:weaklens} we show the results.  Fitting the model in
equation \ref{eq:breakdown}, we found $m \sim 0$ and $\alpha \sim 1$ for the
toy model.  For the image simulations we found $m \sim 0$ and $\alpha \sim
0.6$. We note that \cite{bfd2016} also found the value of $\alpha$
depended on the type of simulation used, with values for $\alpha$
as large as 2.
Taking the value of $\alpha$ from the image simulation, we find that the
non-linearity in this simulation becomes greater than our part in a thousand
goal for shears greater than about 0.04.  Using $\alpha=1$ from the toy
model the threshold is reached for shears higher than about 0.03.

\begin{figure}
	\centering
    \includegraphics[width=\columnwidth]{weaklens-approx.eps}

	\caption{Multiplicative bias as a function of applied shear in a
	simulations.  The circles represent the results for the
	``toy'' simulation presented in the text.  The
    diamonds represent results for the parametric \bdsim\ image simulations.
	For the toy simulation, the bias scales with $\gamma^2$.
	For the image simulation the bias scales 
	as $0.6 \gamma^2$.  The gray
	region represents the target accuracy.}

\label{fig:weaklens}
\end{figure}

Following the discussion in \cite{bfd2016}, we expect the bias on a cosmic
shear measurement to be approximately $1 + 3\alpha\sigma_\gamma^2$, with a
shear variance of $\sigma_\gamma^2 \sim 0.02^2$.  For the $\alpha=0.6$ found in
the image simulations, the bias would be about $7.2 \times 10^{-4}$. 
For $\alpha=1$, the bias would be be about $1.2 \times 10^{-3}$, exceeding our
desired accuracy and requiring some correction.  As pointed out by
\cite{bfd2016}, this correction does not require great precision.  If the bias
were determined at the $\sim 40$\% level for $\alpha=1$,  the shear could be
recovered accurately with 95\% confidence.  More care may be required for
measurements of higher shear, such as tangential shear measurements near the
centers of galaxy clusters.  We will explore strategies to mitigate this
potential bias in a future work.  

\section{Computation Time}

For each 48 by 48 pixel postage stamp, \mcal\ involves performing image
manipulations (Fourier transforms for convolutions and interpolation for the
shear), and image fitting five times: one for the zero shear, but re-convolved
image, and four times for the sheared images.

The total computation time per object was approximately 0.2 seconds.  In our
tests the time was dominated by the image manipulations.  This is partly
because we used the fast \ngmix\ code; fitting each image took only about
0.001 seconds, about 0.005 to fit all five images.  For slower fitting codes,
the \mcal\ manipulations may be sub-dominant.

It may be that further optimization is possible.  For example, a code that
works entirely in Fourier space could avoid rendering the re-convolved image in
real space.

\section{Summary and Future Work} \label{sec:summary}

We introduced a formalism for \mcal\ to calculate shear response corrections,
including corrections for selection effects. We developed a simple empirical
correction for the correlated noise associated with the \mcal\ procedure.  We
then tested the formalism using simulations based on real galaxy images, as well as
challenging parametric simulations that included pre-selection effects and
stellar contamination.  We applied a range of cuts on the object \snr, inducing
significant selection affects.  In all cases we recovered the input shear to
better than a part in a thousand.

\Mcal\ compares favorably with other shear measurement techniques.  At the time
of writing, the only technique with demonstrated accuracy close to \mcal,
without reliance on calibration from simulations, and which accurately
addresses selection effects, is \bfd\ \citep{bfd2016}.  \mcal\
has been tested using more challenging simulations and has proved more
accurate.  \Mcal\ also has the advantage that it does not rely on significant
prior information about galaxy properties.  On the other hand, in our current
implementation we add extra noise to deal with correlated noise effects.  This
extra noise should be unimportant for sample-variance dominated shear
correlation studies; nevertheless we have identified the development of a more
precise correlated noise correction as a priority going forward.

In order to reach part in a thousand accuracy in real data, there are a number
of additional challenges to be addressed, and these challenges are shared with
other shear measurement techniques.
We think the most important are the effects of overlapping objects and the
limitations of current image processing techniques. The accurate determination
of the PSF is also fundamental, but we will not address that here.

Biases in the image processing pipeline that identifies image artifacts,
determines the background light, identifies unique detections, and assigns
light to objects will potentially produce biases in the shear recovery.  Image
artifacts may not be properly corrected for, or masked.  In crowded regions
such as galaxy clusters, the pipeline may fail to determine the background
accurately.  The \mcal\ process will in this case not accurately determine the
response.  Furthermore, in crowded regions the detection algorithm may fail to
identify all the unique objects, due to objects overlapping significantly on
the sky.  The \Mcal\ procedure will correctly estimate the shear response for
these blended objects, but in order to interpret the signal the redshifts of
the objects must be known, at least statistically.  If a significant number of
galaxies are so blended that they are considered one object by the pipeline, it
is unlikely an accurate redshift distribution can be determined.

In a given image, there will also be large numbers of faint galaxies that are
not bright enough to exceed the detection threshold.  These galaxies
effectively become part of the sky.  But they will also be included at some
level in the \mcal\ shear response measured for brighter galaxies.  The effect
is probably much smaller than if one calibrates from simulations \citep[see
e.g.][]{Hoekstra2016}, but may not be negligible.

It may be possible to address these issues by inserting artificial galaxy
images into the data and re-running processing pipelines, including shear
estimation, using the \balrog\ framework \citep{Balrog2016}.  \balrog\
uses the original images as the basis, so all the
features of real observations need not be simulated.  The
approach is particularly applicable to studying the blending effects,
effects of undetected objects, and the effects of image artifacts.

The formalism we have developed recovers a weighted average of the shear, and
this weighting is known, being the same responses used to calibrate the shear
estimate.  In these simulations we simplified further, using a constant shear,
and did not test the variable shear case.  It will be important to test that
this weighting, based on noisy estimates of the responses, can be properly
propagated when interpreting the shear measurements, for example when
estimating the redshift distribution of the source population.

%With \mcal\ these issues can be
%addressed in principle.  Rather than work on sheared postage stamps, the entire
%image can be sheared, and the full processing framework rerun to estimate the
%response.



\begin{comment}
As indicated in table \ref{tab:selresults},
these cuts lead to a monotonic change in the recovered shear, with a few
tenths of a percent bias for a $S/N > 20$ cut.

\begin{table*}
    \centering
    \caption{\Mcal\ results when applying selections on the signal-to-noise ratio (S/N) to the \bdsim\ simulations. Selections
    were applied to an initially unbiased sample; i.e. no {\em detection}
    bias was present in the sample. \label{tab:selresults}}
    \begin{tabular}{ |l| r|r|r|  r|r|r|}
        \hline
        & \multicolumn{3}{c}{Uncorrected for Selection} & \multicolumn{3}{c}{Corrected for Selection} \\
        Selection & $m \times 10{^3} $ & $c_1 \times 10^4$ & $c_2 \times 10^4$ & $m \times 10^{3}$ & $c_1 \times 10^4$ & $c_2 \times 10^4$ \\
        \hline
        %$(S/N) > 5$    & $3.0 \pm 4.4$ & $-0.3 \pm 0.2$ & $0.2 \pm 0.2$ & $3.3 \pm 4.4$ & $-0.3 \pm 0.2$ & $0.2 \pm 0.2$  \\
        $(S/N) > 7.5$  & $-0.7 \pm 0.4$ & $-0.3 \pm 0.2$ & $0.2 \pm 0.2$ & $-0.6 \pm 0.4$ & $-0.3 \pm 0.2$ & $0.2 \pm 0.2$  \\
        $(S/N) > 10$   & $-1.5 \pm 0.5$ & $-0.3 \pm 0.2$ & $0.2 \pm 0.2$ & $-1.0 \pm 0.5$ & $-0.3 \pm 0.2$ & $0.2 \pm 0.2$  \\
        $(S/N) > 15$   & $-2.3 \pm 0.5$ & $0.0 \pm 0.3$ & $0.0 \pm 0.3$ & $-0.9 \pm 0.5$ & $0.0 \pm 0.3$ & $0.0 \pm 0.3$  \\
        $(S/N) > 20$   & $-2.7 \pm 0.6$ & $-0.3 \pm 0.3$ & $-0.2\pm 0.3$ & $-0.9 \pm 0.6$ & $-0.3 \pm 0.3$ & $-0.2 \pm 0.3$  \\
    \end{tabular}
\end{table*}

We implemented a simple correction based on our \mcal\ measurements.  We
sheared the population of ellipticities with a fake shear using the measured
responses \mcalR, and estimated the shear using our \mcal\ mechanism before and
after selection.  We then used the ratio of these numbers as a correction
factor.  We sow the results in table \ref{tab:selresults} in the ``Corrected
for Selection'' column.  This simple correction reduced the bias approximately
$10^{-3}$ in all cases.

In real data, a simple correction scheme like the above will probably require
prior information.  One approach would be to take deep imaging data and add
noise such that the distribution of $S/N$ for the galaxy sample is similar to a
shallower data set.  The noisy ellipticity measurements could then be sheared
artificially and selected as above to derive a correction.  Multiple noise
realizations could be used to increase the precision of the correction.
\end{comment}


\section*{Acknowledgments}

ES is supported by DOE grant DE-AC02-98CH10886.

Many thanks to Paul Stankus for helpful comments on the draft.We are grateful
to Mike Jarvis and Rachel Mandelbaum for many useful discussions and help with
the \galsim\ package. Thanks to Gary Bernstein for suggesting our response for
2-point functions could be simplified.  We thank Aaron Roodman for providing
the variation of the optical aberrations measured in DES data.   Thanks
to Matt Becker for help using the egret simulation package.

\appendix

\section{Alternative Methods for Correlated Noise Correction} \label{sec:altcorr}

\subsection{Correction using \galsim\ Methods}

With guidance from the \galsim\ developers, we attempted to use the \galsim\
noise isotropization and whitening functionality to correct the correlated
noise.  Isotropization enforces four fold symmetry, introducing minimal extra
noise, while whitening completely whitens the image, introducing significant
extra noise.  However, neither of these methods improved the shear recovery in
our simulations.  It may be that some aspects of the \mcal\ procedure
invalidate the assumptions behind these correction methods.


\subsection{Detrending the Correlated Noise Bias} \label{sec:detrend}

\subsubsection{Expected Scaling of the Bias with Noise Level} \label{sec:scaling}

The bias in the ellipticity due to correlated noise should scale with the noise
correlation function, and thus the square of the noise level in the image $n^2$
\citep{Kaiser2000,HirataCorrNoise}.  As discussed in \S \ref{sec:contam}, this
bias will propagate into the response.  We can write the observed \mcalRo\
as a contribution from both the actual response \mcalR\ and a noise term
\mcalRnoise\
\begin{align} \label{eq:scaling}
    \mcalRo &= \mcalR + \mcalRnoise  \nonumber \\
            &= \mcalR + A n^2.
\end{align}

\subsubsection{De-trending Correction Scheme}

We add a small
amount of noise to the image such that $n \rightarrow n + \Delta n$.  If we
then run the new image through the \mcal\ process, we can measure
$R^{\mathrm{before}}$, a response that will include correlated noise effects.
We can write this observed response as
\begin{align}\label{eq:Rbefore}
    \mcalRo^{\mathrm{before}} &= \mcalR + A (n + \Delta n)^2 \nonumber \\
       &\simeq \mcalR + A n^2 + 2 A n \Delta n
\end{align}
%&\simeq R + A n^2 + \frac{\partial (An^2)}{\partial n} \Delta n + ... \nonumber \\
where we have dropped terms of order $(\Delta n)^2$ and higher.  In equation
\ref{eq:Rbefore}, \mcalR\ is the response at noise $n+\Delta n$ in the absence
of correlated noise.  

We can also add identical noise {\em after} the original image  has been run
through \mcal, and measure $R^{\mathrm{after}}$.  The response when adding
noise after \mcal\ does not suffer any additional bias due to correlated noise:
\begin{align}
    \mcalRo^{\mathrm{after}} &= \mcalR + A n^2.
\end{align}
The difference between these responses is then 
\begin{align}
    \Delta \mcalR &\equiv \mcalRo^{\mathrm{before}} - \mcalRo^{\mathrm{after}}  \nonumber \\
             &\simeq 2 A n \Delta n.
\end{align}

We propose the following procedure to correct for correlated noise:
\begin{enumerate}
    \item Calculate $\Delta \mcalR$ for a series of noise offsets $\Delta n$.
    \item Average $\Delta \mcalR$ over all objects for each noise offset.
    \item Perform a linear fit to $\Delta \mcalR$ vs. $2 n \Delta n$ to find the 
        coefficient $A$.
    \item Apply a mean correction for correlated noise given by
        \begin{align}
            \mcalRnoise & \simeq A n^2.
        \end{align}
\end{enumerate}
If the noise varies between observations, we can apply a 
correction based on the mean variance $A
\langle n^2 \rangle$.

\subsubsection{Measurements of the \detrend\ Parameters}

We measured $\Delta R$ vs $2 n \Delta n$ to find the
coefficient $A$.  In figure \ref{fig:detrend}, we show this fit for the \rgsim\
simulation.  The trend is well-fit by a linear model, as expected, with a slope
$A \simeq $\Aslope, implying a correction $A n^2 \simeq$ \Rcorr\ for this
simulation.

\begin{figure}
	\centering
    \includegraphics[width=0.5\columnwidth]{mcal-v14s01-Rnoise-detrend-R11.eps}

    \caption{Trend of $\Delta R_{1,1}$ with $2 n \Delta n$ for the
        real galaxy simulation.   $n$ is the
    original noise level and $\Delta n$ is the additional noise added.  The
    trend is linear as predicted.}

\label{fig:detrend}
\end{figure}




\subsubsection{Using a Random Subset To Calculate \Detrend\ Corrections}

Measuring the \detrend\ parameters requires extra computations, at least a
factor of three to fit the linear parameters given in \S \ref{sec:detrend}, and
a factor of four if an additional point is used to check for possible
non-linearity. These extra computations could be expensive for large surveys.  

However, the \detrend\ parameters are more precisely measured than the shear
itself.  Here we explore the precision of the recovered shear using smaller
subsets of the object catalog to measure the \detrend\ parameters, and
applying the corrections to the full sample.  In Table \ref{tab:subsets}
we show the shear recovery parameters for various subset sizes, for the
\bdsim\ simulation described in \S \ref{sec:results}



We find that a relatively small sample can be used to determine the correlated
noise correction.  Calculating the detrending terms for 10\% of the sample
leads to only 0.3\% extra variance in the recovered shear, and using 1\% of
galaxies leads to only 4.4\% increase in variance.

To calculate these numbers we have assumed the extra uncertainty is added
quadratically with the uncertainty measured using all galaxies to estimate the
\detrend\ parameters; e.g for the first row, we have added approximately 30\%
quadratically with the measured uncertainty, resulting in a net increase of
4.4\%.

It is important to use a truly random subset of the population to determine the
corrections, including a fair sample of stars and other contaminants, and a
representative amount of pixel level masking.  If a particular aggregate shear
measurement involves a selection, this selection must also be applied to the
random subset.

\subsubsection{Performance of the \detrend\ method}

We found this method did not work as well as the \fixnoise\ method
described in \S \ref{sec:fixnoise}.  We detected a remaining bias
of $m \sim 2 \times 10^{-3}$ in both the \bdsim\ and \rgsim\ simulations.

\subsection{Simulating Models}

In this method, we generated model images with the correct noise level corresponding
to each real image.  We then measured the response of the noise due to the
convolutions and shears used in \mcal, with noise added before and
after the \mcal\ procedure.

The measurement with correlated noise will be the sum of the response
without correlated noise plus the response of the correlated noise field
\begin{equation}
    \mcalRnoisemodel = \mcalRmodel + \mcalRnoise.
\end{equation}
This measurement is quite noisy for a single galaxy, but we
can estimate the mean correlated noise response for an ensemble
of galaxies
\begin{equation}
    \langle \mcalRnoise \rangle = \langle \mcalRnoisemodel \rangle - \langle \mcalRmodel \rangle.
\end{equation}
Each entry used in this average corresponds to the best fit model
and noise properties for a galaxy in the sample.

The response \mcalRnoise\ can be subtracted to recover an estimate of the mean
response without correlated noise
\begin{equation}
    \langle \mcalR \rangle = \langle \mcalRo \rangle - \langle \mcalRnoise \rangle.
\end{equation}

We detected significant bias using both exponential and Gaussian
models for the galaxy.  We detected a remaining bias of  $m \sim 4 \times
10^{-3}$ in both the \bdsim\ and \rgsim\ simulations.

\begin{table*}
    \centering
    \begin{tabular}{ c  c }
        Subset Size & Extra Error \\
        \hline
        1\% & 4.4\% \\
        5\% & 0.8\% \\
        10\% & 0.3\% \\
    \end{tabular}

    \parbox{0.7\columnwidth}{
		\caption{\begin{flushleft}Additional variance in the recovered shear 
			using different sized subsets to
			estimate the detrending corrections.  Values were obtained
		from 100 bootstrap samples. \label{tab:subsets}\end{flushleft}}
	}

\end{table*}
%        1\% & 30\% \\
%        5\% & 13\% \\
%        10\% & 8\% \\


\bibliographystyle{mnras}
% Bib database
\bibliography{apj-jour,astroref}

\end{document}

